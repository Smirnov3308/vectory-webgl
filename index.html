<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vectory - Particle System</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --background: 240 10% 3.9%;
      --foreground: 0 0% 98%;
      --card: 240 10% 3.9%;
      --primary: 0 0% 98%;
      --primary-foreground: 240 5.9% 10%;
      --secondary: 240 3.7% 15.9%;
      --secondary-foreground: 0 0% 98%;
      --muted: 240 3.7% 15.9%;
      --muted-foreground: 240 5% 64.9%;
      --border: 240 3.7% 15.9%;
      --input: 240 3.7% 15.9%;
      --ring: 240 4.9% 83.9%;
      --radius: 0.5rem;
      --success: 142 70% 45%;
      --danger: 0 72% 51%;
    }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: hsl(var(--background));
      color: hsl(var(--foreground));
      height: 100dvh;
      display: flex;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }
    
    /* Desktop sidebar - hidden on mobile */
    #controls {
      width: 300px;
      min-width: 300px;
      background: hsl(var(--background));
      border-right: 1px solid hsl(var(--border));
      display: flex;
      flex-direction: column;
      height: 100dvh;
    }
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid hsl(var(--border));
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo h1 { font-size: 16px; font-weight: 600; }
    .logo-subtitle { font-size: 12px; color: hsl(var(--muted-foreground)); margin-top: 2px; }
    .header-actions { display: flex; gap: 4px; }
    .header-actions button { width: 36px; height: 36px; padding: 0; }
    .sidebar-content { flex: 1; overflow-y: auto; padding: 12px; }
    .section { margin-bottom: 2px; }
    .section-trigger {
      display: flex; align-items: center; justify-content: space-between; width: 100%;
      padding: 10px 12px; background: transparent; border: none; border-radius: var(--radius);
      color: hsl(var(--foreground)); font-size: 14px; font-weight: 500; cursor: pointer; text-align: left;
    }
    .section-trigger:hover { background: hsl(var(--muted)); }
    .section-trigger svg { width: 16px; height: 16px; color: hsl(var(--muted-foreground)); transition: transform 0.2s; }
    .section.collapsed .section-trigger svg { transform: rotate(-90deg); }
    .section.collapsed .section-content { display: none; }
    .section-content { padding: 8px 12px 12px; }
    .control-group { margin-bottom: 16px; }
    .control-group:last-child { margin-bottom: 0; }
    label {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 14px; font-weight: 500; margin-bottom: 8px;
    }
    label .value {
      font-family: 'JetBrains Mono', monospace; font-size: 12px;
      color: hsl(var(--muted-foreground)); background: hsl(var(--muted));
      padding: 2px 6px; border-radius: 4px;
    }
    input[type="range"] {
      width: 100%; height: 8px; -webkit-appearance: none;
      background: hsl(var(--secondary)); border-radius: 9999px; cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 16px; height: 16px;
      background: hsl(var(--primary)); border-radius: 9999px; cursor: pointer;
    }
    select, input[type="file"], input[type="color"] {
      width: 100%; height: 36px; padding: 0 12px;
      background: hsl(var(--background)); border: 1px solid hsl(var(--input));
      border-radius: var(--radius); color: hsl(var(--foreground)); font-size: 14px;
    }
    .checkbox-wrapper { display: flex; align-items: center; gap: 8px; }
    .checkbox-wrapper input { width: 16px; height: 16px; }
    .checkbox-wrapper label { margin: 0; }
    button {
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      height: 36px; padding: 0 16px; background: hsl(var(--primary)); color: hsl(var(--primary-foreground));
      border: none; border-radius: var(--radius); font-size: 14px; font-weight: 500; cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    button:active { transform: scale(0.98); }
    button.secondary { background: hsl(var(--secondary)); color: hsl(var(--secondary-foreground)); }
    button.outline { background: transparent; border: 1px solid hsl(var(--input)); color: hsl(var(--foreground)); }
    button.ghost { background: transparent; color: hsl(var(--foreground)); }
    button.recording { background: hsl(var(--danger)); animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .preset-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
    .preset-grid button { height: 32px; font-size: 13px; padding: 0 10px; }
    .preview-box {
      width: 100%; height: 80px; background: hsl(var(--muted)); border: 1px solid hsl(var(--border));
      border-radius: var(--radius); display: flex; align-items: center; justify-content: center; margin-top: 8px;
    }
    .preview-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .preview-box span { font-size: 13px; color: hsl(var(--muted-foreground)); }
    .sidebar-footer { padding: 12px; border-top: 1px solid hsl(var(--border)); display: flex; gap: 8px; }
    .sidebar-footer button { flex: 1; }
    
    /* Canvas container */
    #canvas-container {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 12px; background: hsl(var(--background)); position: relative; overflow: hidden;
    }
    .stats-bar {
      display: flex; gap: 20px; padding: 10px 16px; background: hsl(var(--card));
      border: 1px solid hsl(var(--border)); border-radius: var(--radius); margin-bottom: 12px;
      font-size: 13px; font-family: 'JetBrains Mono', monospace;
    }
    .stat { display: flex; align-items: center; gap: 8px; }
    .stat-label { color: hsl(var(--muted-foreground)); }
    .stat-value { color: hsl(var(--foreground)); font-weight: 500; }
    .stat-value.fps { color: hsl(var(--success)); }
    #canvas-wrapper { position: relative; }
    canvas { border-radius: var(--radius); border: 1px solid hsl(var(--border)); touch-action: none; }
    .flash-overlay {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: white; opacity: 0; pointer-events: none; border-radius: var(--radius);
    }
    .flash-overlay.flash { animation: flashAnim 0.25s ease-out; }
    @keyframes flashAnim { 0% { opacity: 0.7; } 100% { opacity: 0; } }
    .rotate-hint {
      position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
      padding: 10px 14px; background: hsl(var(--card) / 0.95); backdrop-filter: blur(8px);
      border: 1px solid hsl(var(--border)); border-radius: var(--radius);
      font-size: 13px; color: hsl(var(--muted-foreground)); pointer-events: none;
      transition: opacity 0.3s;
    }
    .rotate-hint.hidden { opacity: 0; }
    .rotate-hint kbd {
      display: inline-flex; align-items: center; height: 20px; padding: 0 6px;
      background: hsl(var(--muted)); border: 1px solid hsl(var(--border)); border-radius: 4px;
      font-family: 'JetBrains Mono', monospace; font-size: 11px; margin: 0 3px;
    }
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
      display: flex; align-items: center; gap: 10px; padding: 12px 16px;
      background: hsl(var(--card)); border: 1px solid hsl(var(--border)); border-radius: var(--radius);
      font-size: 14px; opacity: 0; transition: transform 0.3s, opacity 0.3s; z-index: 1000;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast-icon {
      width: 20px; height: 20px; background: hsl(var(--success)); border-radius: 9999px;
      display: flex; align-items: center; justify-content: center;
    }
    .toast-icon svg { width: 12px; height: 12px; color: white; }
    
    /* ===== MOBILE STYLES ===== */
    @media (max-width: 900px) {
      body { flex-direction: column; }
      #controls { display: none !important; }
      #canvas-container { flex: 1; padding: 0; }
      .stats-bar { display: none; }
      
      /* Mobile floating stats */
      .mobile-stats {
        position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
        display: flex; gap: 16px; padding: 8px 14px;
        background: hsl(var(--card) / 0.9); backdrop-filter: blur(8px);
        border: 1px solid hsl(var(--border)); border-radius: var(--radius);
        font-size: 12px; font-family: 'JetBrains Mono', monospace;
        opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 20;
      }
      .mobile-stats.visible { opacity: 1; }
      .mobile-stats .stat-value.fps { color: hsl(var(--success)); }
      
      #canvas-wrapper { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
      canvas { max-width: 100%; max-height: 100%; width: 100% !important; height: 100% !important; border: none; border-radius: 0; }
      
      /* Preset carousel */
      .mobile-presets {
        position: fixed; bottom: 70px; left: 0; right: 0;
        display: flex; gap: 8px; padding: 10px 16px;
        overflow-x: auto; scrollbar-width: none; z-index: 50;
      }
      .mobile-presets::-webkit-scrollbar { display: none; }
      .mobile-presets button {
        flex-shrink: 0; height: 36px; padding: 0 14px;
        background: hsl(var(--card) / 0.9); backdrop-filter: blur(8px);
        border: 1px solid hsl(var(--border)); border-radius: 18px;
        font-size: 13px; font-weight: 500; color: hsl(var(--foreground));
      }
      .mobile-presets button.active {
        background: hsl(var(--primary)); color: hsl(var(--primary-foreground)); border-color: hsl(var(--primary));
      }
      
      /* Toolbar */
      .mobile-toolbar {
        position: fixed; bottom: 0; left: 0; right: 0;
        display: flex; align-items: center; justify-content: center; gap: 6px;
        padding: 12px 16px; padding-bottom: max(12px, env(safe-area-inset-bottom));
        background: hsl(var(--card) / 0.95); backdrop-filter: blur(12px);
        border-top: 1px solid hsl(var(--border)); z-index: 100;
      }
      .mobile-toolbar button { width: 44px; height: 44px; padding: 0; border-radius: 12px; background: hsl(var(--secondary)); }
      .mobile-toolbar button svg { width: 20px; height: 20px; }
      .mobile-toolbar button.active { background: hsl(var(--success)); color: white; }
      .mobile-toolbar button.recording { background: hsl(var(--danger)); color: white; }
      .mobile-toolbar .desktop-hint { font-size: 10px; color: hsl(var(--muted-foreground)); margin-left: 8px; }
      
      /* Quick settings */
      .quick-settings {
        position: fixed; bottom: 130px; left: 16px; right: 16px;
        max-width: 320px; margin: 0 auto; padding: 16px;
        background: hsl(var(--card) / 0.95); backdrop-filter: blur(12px);
        border: 1px solid hsl(var(--border)); border-radius: 16px; z-index: 60;
        transform: translateY(20px); opacity: 0; pointer-events: none;
        transition: transform 0.25s, opacity 0.25s;
      }
      .quick-settings.visible { transform: translateY(0); opacity: 1; pointer-events: auto; }
      .quick-settings-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
      .quick-settings-header h3 { font-size: 14px; font-weight: 600; }
      .quick-settings-header button { width: 28px; height: 28px; padding: 0; background: transparent; }
      .quick-settings .control-group { margin-bottom: 14px; }
      .quick-settings label { font-size: 13px; margin-bottom: 8px; }
      .quick-settings input[type="range"]::-webkit-slider-thumb { width: 20px; height: 20px; }
      .quick-settings .advanced-link {
        display: block; width: 100%; margin-top: 12px; padding: 10px;
        background: hsl(var(--muted)); border: none; border-radius: var(--radius);
        font-size: 13px; color: hsl(var(--muted-foreground)); text-align: center;
      }
      
      /* Swipe indicators */
      .swipe-indicator {
        position: absolute; top: 50%; transform: translateY(-50%);
        padding: 12px 16px; background: hsl(var(--card) / 0.9); backdrop-filter: blur(8px);
        border: 1px solid hsl(var(--border)); border-radius: var(--radius);
        font-size: 14px; font-weight: 500; opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 30;
      }
      .swipe-indicator.left { left: 20px; }
      .swipe-indicator.right { right: 20px; }
      .swipe-indicator.visible { opacity: 1; }
      
      .rotate-hint { display: none; }
      .toast { bottom: 140px; }
    }
    
    @media (min-width: 901px) {
      .mobile-presets, .mobile-toolbar, .mobile-stats, .quick-settings, .swipe-indicator { display: none !important; }
      .rotate-hint .hint-mobile { display: none; }
    }
  </style>
</head>
<body>
  <!-- Desktop sidebar (same as original, abbreviated for space) -->
  <div id="controls">
    <div class="sidebar-header">
      <div class="logo"><h1>Vectory</h1><p class="logo-subtitle">Particle System</p></div>
      <div class="header-actions">
        <button class="ghost" id="shareBtn" title="Share"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg></button>
        <button class="ghost" id="fullscreenBtn" title="Fullscreen"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg></button>
      </div>
    </div>
    <div class="sidebar-content">
      <button class="secondary" id="webcamBtn" style="width:100%;margin-bottom:8px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg> Camera</button>
      
      <div class="section">
        <button class="section-trigger" onclick="toggleSection(this)">Presets<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></button>
        <div class="section-content">
          <div class="preset-grid">
            <button class="outline" data-preset="matrix">üíö Matrix</button>
            <button class="outline" data-preset="silk">üßµ Silk</button>
            <button class="outline" data-preset="fire">üî• Fire</button>
            <button class="outline" data-preset="rain">üåßÔ∏è Rain</button>
            <button class="outline" data-preset="neon">üíú Neon</button>
            <button class="outline" data-preset="speed">‚ö° Speed</button>
            <button class="outline" data-preset="galaxy">üåå Galaxy</button>
            <button class="outline" data-preset="ocean">üåä Ocean</button>
            <button class="outline" data-preset="snow">‚ùÑÔ∏è Snow</button>
            <button class="outline" data-preset="aurora">üåà Aurora</button>
            <button class="outline" data-preset="smoke">üí® Smoke</button>
            <button class="outline" data-preset="cyber">ü§ñ Cyber</button>
            <button class="outline" data-preset="gold">‚ú® Gold</button>
            <button class="outline" data-preset="plasma">‚ö° Plasma</button>
          </div>
        </div>
      </div>
      
      <div class="section">
        <button class="section-trigger" onclick="toggleSection(this)">Image<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></button>
        <div class="section-content">
          <input type="file" id="imageInput" accept="image/*">
          <div class="preview-box" id="imagePreview"><span>Source Image</span></div>
          <div class="preset-grid" style="margin-top:6px;">
            <button class="outline" id="presetNoise">Noise</button>
            <button class="outline" id="presetGradient">Gradient</button>
            <button class="outline" id="presetRadial">Radial</button>
            <button class="outline" id="preset3DFlow">3D Flow</button>
          </div>
        </div>
      </div>
      
      <div class="section">
        <button class="section-trigger" onclick="toggleSection(this)">Edge Detection<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></button>
        <div class="section-content">
          <div class="control-group"><label>Method</label><select id="edgeMethod"><option value="1">Sobel</option><option value="2">Canny</option></select></div>
          <div class="control-group"><label>Edge ‚Üí Size <span class="value" id="edgeSizeVal">0%</span></label><input type="range" id="edgeSize" min="0" max="100" value="0"></div>
          <div class="control-group"><label>Edge ‚Üí Opacity <span class="value" id="edgeOpacityVal">0%</span></label><input type="range" id="edgeOpacity" min="0" max="100" value="0"></div>
          <div class="control-group"><label>Edge ‚Üí Attract <span class="value" id="edgeAttrVal">0</span></label><input type="range" id="edgeAttr" min="0" max="100" value="0"></div>
        </div>
      </div>
      
      <div class="section">
        <button class="section-trigger" onclick="toggleSection(this)">Mode<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></button>
        <div class="section-content">
          <select id="mode">
            <option value="1">Particles 2D</option>
            <option value="2">Static Trails 2D</option>
            <option value="3">Moving Trails 2D</option>
            <option value="4" selected>Particles 3D</option>
            <option value="5">Trails 3D</option>
          </select>
        </div>
      </div>
      
      <div class="section" id="section3D">
        <button class="section-trigger" onclick="toggleSection(this)">3D Settings<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></button>
        <div class="section-content">
          <div class="control-group"><label>Spawn Mode</label><select id="spawn3DMode"><option value="1">Flat (Z=0)</option><option value="2" selected>Brightness ‚Üí Depth</option><option value="3">Random Depth</option></select></div>
          <div class="control-group"><label>Direction Source</label><select id="dir3DSource"><option value="1">2D (use Direction)</option><option value="2" selected>RGB ‚Üí XYZ</option></select></div>
          <div class="control-group"><label>Depth <span class="value" id="depthScaleVal">100</span></label><input type="range" id="depthScale" min="10" max="300" value="100"></div>
          <div class="control-group"><label>Image Attract <span class="value" id="imgAttrVal">0</span></label><input type="range" id="imgAttr" min="0" max="100" value="0"></div>
          <div class="control-group"><label>Distance <span class="value" id="camDistVal">850</span></label><input type="range" id="camDist" min="100" max="1000" value="850"></div>
          <div class="control-group"><label>FOV <span class="value" id="fovVal">60¬∞</span></label><input type="range" id="fov" min="30" max="120" value="60"></div>
        </div>
      </div>
      
      <div class="section">
        <button class="section-trigger" onclick="toggleSection(this)">Particle<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></button>
        <div class="section-content">
          <div class="control-group"><label>Lifetime <span class="value" id="lifetimeVal">100</span></label><input type="range" id="lifetime" min="10" max="500" value="100"></div>
          <div class="control-group"><label>Size <span class="value" id="sizeVal">3</span></label><input type="range" id="size" min="1" max="30" value="3"></div>
          <div class="control-group"><label>Speed <span class="value" id="speedVal">2</span></label><input type="range" id="speed" min="0.5" max="20" value="2" step="0.5"></div>
          <div class="control-group"><label>Count <span class="value" id="countVal">1000</span></label><input type="range" id="count" min="1" max="2000" value="1000"></div>
        </div>
      </div>
      
      <div class="section collapsed">
        <button class="section-trigger" onclick="toggleSection(this)">Direction<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></button>
        <div class="section-content">
          <div class="control-group"><label>Channel</label><select id="channel"><option value="1" selected>Brightness</option><option value="2">Red</option></select></div>
          <div class="control-group"><label>Shift <span class="value" id="shiftVal">0¬∞</span></label><input type="range" id="shift" min="-180" max="180" value="0"></div>
          <div class="control-group"><label>Fluctuation <span class="value" id="fluctVal">0¬∞</span></label><input type="range" id="fluct" min="0" max="180" value="0"></div>
          <div class="control-group"><label>Dynamic Fluct <span class="value" id="dynFluctVal">0¬∞</span></label><input type="range" id="dynFluct" min="0" max="180" value="0"></div>
          <div class="control-group"><label>Attract Force <span class="value" id="attrForceVal">0</span></label><input type="range" id="attrForce" min="-10" max="10" value="0"></div>
          <div class="control-group"><label>Attract Angle <span class="value" id="attrAngleVal">0¬∞</span></label><input type="range" id="attrAngle" min="0" max="360" value="0"></div>
        </div>
      </div>
      
      <div class="section collapsed">
        <button class="section-trigger" onclick="toggleSection(this)">Spawn<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></button>
        <div class="section-content">
          <div class="control-group"><label>Seed <span class="value" id="seedVal">1</span></label><input type="range" id="seed" min="1" max="100" value="1"></div>
          <div class="control-group"><label>Spawn Type</label><select id="spawnType"><option value="1" selected>Random</option><option value="2">Brightness</option></select></div>
          <div class="control-group"><label>Cutoff <span class="value" id="cutoffVal">30%</span></label><input type="range" id="cutoff" min="0" max="100" value="30"></div>
        </div>
      </div>
      
      <div class="section collapsed">
        <button class="section-trigger" onclick="toggleSection(this)">Color<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></button>
        <div class="section-content">
          <div class="control-group"><select id="colorMode"><option value="1" selected>Original</option><option value="2">Sample Position</option><option value="3">Custom</option><option value="4">Lifetime Gradient</option><option value="5">Depth Gradient</option></select></div>
          <div class="control-group"><label>Custom</label><input type="color" id="customColor" value="#ffffff"></div>
          <div class="control-group"><label>Start</label><input type="color" id="startColor" value="#ffffff"></div>
          <div class="control-group"><label>End</label><input type="color" id="endColor" value="#e94560"></div>
        </div>
      </div>
      
      <div class="section collapsed">
        <button class="section-trigger" onclick="toggleSection(this)">Glow<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></button>
        <div class="section-content">
          <div class="control-group"><div class="checkbox-wrapper"><input type="checkbox" id="glowEnabled"><label for="glowEnabled">Enable Glow</label></div></div>
          <div class="control-group"><label>Intensity <span class="value" id="glowIntensityVal">1.0</span></label><input type="range" id="glowIntensity" min="0.1" max="3" value="1" step="0.1"></div>
          <div class="control-group"><label>Radius <span class="value" id="glowRadiusVal">20</span></label><input type="range" id="glowRadius" min="5" max="50" value="20"></div>
        </div>
      </div>
      
      <div class="section collapsed">
        <button class="section-trigger" onclick="toggleSection(this)">Background<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></button>
        <div class="section-content">
          <div class="control-group"><div class="checkbox-wrapper"><input type="checkbox" id="transparentBg" checked><label for="transparentBg">Transparent</label></div></div>
          <div class="control-group"><label>Color</label><input type="color" id="bgColor" value="#09090b"></div>
          <div class="control-group"><label>Fade <span class="value" id="fadeVal">3</span></label><input type="range" id="fade" min="1" max="50" value="3"></div>
        </div>
      </div>
    </div>
    <div class="sidebar-footer">
      <button class="secondary" id="resetBtn">Reset</button>
      <button class="secondary" id="recordBtn">‚óè Rec</button>
      <button id="saveBtn">Save</button>
    </div>
  </div>
  
  <!-- Canvas container -->
  <div id="canvas-container">
    <div class="stats-bar">
      <div class="stat"><span class="stat-label">FPS</span><span class="stat-value fps" id="fpsDisplay">--</span></div>
      <div class="stat"><span class="stat-label">Particles</span><span class="stat-value" id="particleCount">0</span></div>
    </div>
    <div class="mobile-stats" id="mobileStats">
      <span><span class="stat-value fps" id="mobileFps">--</span> FPS</span>
      <span><span id="mobileParticleCount">0</span> particles</span>
    </div>
    <div id="canvas-wrapper">
      <canvas id="glCanvas"></canvas>
      <div class="flash-overlay" id="flashOverlay"></div>
      <div class="rotate-hint" id="rotateHint">
        <span class="hint-desktop">Drag to rotate ¬∑ <kbd>Scroll</kbd> zoom ¬∑ <kbd>F</kbd> fullscreen</span>
      </div>
    </div>
    <div class="swipe-indicator left" id="swipeLeft">‚Üê Previous</div>
    <div class="swipe-indicator right" id="swipeRight">Next ‚Üí</div>
  </div>
  
  <!-- Mobile preset carousel -->
  <div class="mobile-presets" id="mobilePresets">
    <button data-preset="matrix" class="active">üíö Matrix</button>
    <button data-preset="silk">üßµ Silk</button>
    <button data-preset="fire">üî• Fire</button>
    <button data-preset="rain">üåßÔ∏è Rain</button>
    <button data-preset="neon">üíú Neon</button>
    <button data-preset="speed">‚ö° Speed</button>
    <button data-preset="galaxy">üåå Galaxy</button>
    <button data-preset="ocean">üåä Ocean</button>
    <button data-preset="snow">‚ùÑÔ∏è Snow</button>
    <button data-preset="aurora">üåà Aurora</button>
    <button data-preset="smoke">üí® Smoke</button>
    <button data-preset="cyber">ü§ñ Cyber</button>
    <button data-preset="gold">‚ú® Gold</button>
    <button data-preset="plasma">‚ö° Plasma</button>
  </div>
  
  <!-- Mobile toolbar -->
  <div class="mobile-toolbar" id="mobileToolbar">
    <button id="mobileSettingsBtn" title="Settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></button>
    <button id="mobileWebcamBtn" title="Camera"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg></button>
    <button id="mobileFlipCamBtn" title="Flip Camera" style="display:none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5"/><path d="M13 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-5"/><circle cx="12" cy="12" r="3"/><path d="m18 22-3-3 3-3"/><path d="m6 2 3 3-3 3"/></svg></button>
    <button id="mobileRecordBtn" title="Record"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4" fill="currentColor"/></svg></button>
    <button id="mobileSaveBtn" title="Save"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg></button>
    <span class="desktop-hint">Desktop for more ‚Üí</span>
  </div>
  
  <!-- Quick settings panel -->
  <div class="quick-settings" id="quickSettings">
    <div class="quick-settings-header">
      <h3>Quick Settings</h3>
      <button id="closeQuickSettings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
    </div>
    <div class="control-group"><label>Speed <span class="value" id="qSpeedVal">2</span></label><input type="range" id="qSpeed" min="0.5" max="20" value="2" step="0.5"></div>
    <div class="control-group"><label>Size <span class="value" id="qSizeVal">3</span></label><input type="range" id="qSize" min="1" max="30" value="3"></div>
    <div class="control-group"><label>Count <span class="value" id="qCountVal">1000</span></label><input type="range" id="qCount" min="10" max="2000" value="1000"></div>
  </div>
  
  <div class="toast" id="toast"><div class="toast-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div><span id="toastMessage">Saved!</span></div>


<script>
function toggleSection(t){t.parentElement.classList.toggle('collapsed');}

const defaultSettings={mode:4,seed:1,spawnType:1,count:1000,cutoff:30,edgeMethod:1,edgeSize:0,edgeOpacity:0,edgeAttr:0,lifetime:100,size:3,speed:2,channel:1,shift:0,fluct:0,dynFluct:0,attrForce:0,attrAngle:0,colorMode:1,customColor:'#ffffff',startColor:'#ffffff',endColor:'#e94560',transparentBg:true,bgColor:'#09090b',fade:3,camDist:850,fov:60,depthScale:100,spawn3DMode:2,dir3DSource:2,imgAttr:0,glowEnabled:false,glowIntensity:1,glowRadius:20,glowThreshold:0};
let settings={...defaultSettings};
const presetNames=['matrix','silk','fire','rain','neon','speed','galaxy','ocean','snow','aurora','smoke','cyber','gold','plasma'];
let currentPresetIndex=0;

const presets={
  matrix:{mode:2,count:800,size:2,speed:4,lifetime:100,colorMode:4,startColor:'#22c55e',endColor:'#052e16',attrForce:3,attrAngle:270,fluct:122,dynFluct:67,edgeMethod:2,edgeSize:28,edgeOpacity:100,edgeAttr:6,glowEnabled:true,glowIntensity:3,glowRadius:5},
  silk:{mode:2,count:1000,size:1,speed:1,lifetime:500,colorMode:1,fluct:180,edgeMethod:1,edgeSize:60,edgeOpacity:0,edgeAttr:0,glowEnabled:false},
  fire:{mode:4,count:1000,size:4,speed:3,lifetime:80,colorMode:4,startColor:'#fbbf24',endColor:'#dc2626',attrForce:-2,attrAngle:270,depthScale:80,edgeMethod:2,edgeSize:100,edgeOpacity:50,edgeAttr:50,glowEnabled:true,glowIntensity:1.2,glowRadius:20},
  rain:{mode:3,count:150,size:2,speed:8,lifetime:30,colorMode:3,customColor:'#60a5fa',attrForce:8,attrAngle:270,fade:20,edgeMethod:1,edgeSize:0,edgeOpacity:63,edgeAttr:0,glowEnabled:false},
  neon:{mode:5,count:80,size:3,speed:2,lifetime:80,colorMode:4,startColor:'#ec4899',endColor:'#3b82f6',depthScale:150,fade:15,edgeMethod:2,edgeSize:100,edgeOpacity:75,edgeAttr:33,glowEnabled:true,glowIntensity:1.0,glowRadius:15},
  speed:{mode:3,count:100,size:2,speed:8,lifetime:30,colorMode:4,startColor:'#ffffff',endColor:'#6366f1',fade:25,edgeMethod:1,edgeSize:0,edgeOpacity:0,edgeAttr:67,glowEnabled:false},
  galaxy:{mode:4,count:1500,size:2,speed:1,lifetime:200,colorMode:4,startColor:'#e0e7ff',endColor:'#7c3aed',depthScale:200,camDist:600,fov:70,fluct:60,dynFluct:30,attrForce:0.5,attrAngle:0,spawn3DMode:3,glowEnabled:true,glowIntensity:1.5,glowRadius:25},
  ocean:{mode:2,count:600,size:2,speed:2,lifetime:150,colorMode:4,startColor:'#22d3ee',endColor:'#0369a1',attrForce:2,attrAngle:180,fluct:45,dynFluct:25,edgeMethod:2,edgeSize:50,edgeOpacity:60,edgeAttr:20,glowEnabled:true,glowIntensity:0.8,glowRadius:15},
  snow:{mode:1,count:300,size:3,speed:1,lifetime:200,colorMode:3,customColor:'#ffffff',attrForce:2,attrAngle:270,fluct:30,dynFluct:40,edgeMethod:1,edgeSize:0,edgeOpacity:0,edgeAttr:0,glowEnabled:false,transparentBg:false,bgColor:'#1e293b'},
  aurora:{mode:3,count:80,size:4,speed:1,lifetime:100,colorMode:4,startColor:'#34d399',endColor:'#a855f7',attrForce:-1,attrAngle:90,fluct:20,fade:30,edgeMethod:2,edgeSize:80,edgeOpacity:50,edgeAttr:15,glowEnabled:true,glowIntensity:2,glowRadius:30},
  smoke:{mode:2,count:400,size:4,speed:1,lifetime:200,colorMode:4,startColor:'#94a3b8',endColor:'#1e293b',attrForce:-1.5,attrAngle:90,fluct:90,dynFluct:60,edgeMethod:2,edgeSize:70,edgeOpacity:40,edgeAttr:10,glowEnabled:false},
  cyber:{mode:5,count:120,size:2,speed:5,lifetime:50,colorMode:4,startColor:'#f472b6',endColor:'#06b6d4',depthScale:120,fade:20,edgeMethod:2,edgeSize:100,edgeOpacity:80,edgeAttr:40,glowEnabled:true,glowIntensity:2,glowRadius:12},
  gold:{mode:4,count:800,size:3,speed:2,lifetime:120,colorMode:4,startColor:'#fcd34d',endColor:'#b45309',depthScale:100,fluct:40,dynFluct:20,spawn3DMode:2,glowEnabled:true,glowIntensity:1.8,glowRadius:20},
  plasma:{mode:2,count:500,size:3,speed:3,lifetime:80,colorMode:4,startColor:'#ffffff',endColor:'#ef4444',fluct:150,dynFluct:80,edgeMethod:2,edgeSize:100,edgeOpacity:100,edgeAttr:30,glowEnabled:true,glowIntensity:2.5,glowRadius:18}
};

let gl,canvas,program,lineProgram,positionBuffer,colorBuffer,sizeBuffer,uProjection,uView,uResolution,uIs3D;
let glowProgram,compositeProgram,quadBuffer,framebufferA,framebufferB,framebufferMain,textureA,textureB,textureMain;
// Cached uniform/attrib locations for glow
let glowLocs={},compositeLocs={},lineLocs={},mainLocs={};
// Reusable buffers for static trails
const STATIC_MAX=500000;
let staticPos=new Float32Array(STATIC_MAX*3),staticCol=new Float32Array(STATIC_MAX*4),staticSiz=new Float32Array(STATIC_MAX);
// Cached color conversions
let cachedColors={},lastColorSettings='';
const MAX_PARTICLES=200000;
let particleCount=0,positions=new Float32Array(MAX_PARTICLES*3),colors=new Float32Array(MAX_PARTICLES*4),sizes=new Float32Array(MAX_PARTICLES),velocities=new Float32Array(MAX_PARTICLES*3),lifetimes=new Float32Array(MAX_PARTICLES),maxLifetimes=new Float32Array(MAX_PARTICLES),origPositions=new Float32Array(MAX_PARTICLES*3),particleFluct=new Float32Array(MAX_PARTICLES),particleIds=new Uint32Array(MAX_PARTICLES),particleIdCounter=0,particleSpeeds=new Float32Array(MAX_PARTICLES);
let trailPositions=new Float32Array(MAX_PARTICLES*20*3),trailColors=new Float32Array(MAX_PARTICLES*20*4),trailSizes=new Float32Array(MAX_PARTICLES*20),trailCounts=new Uint16Array(MAX_PARTICLES),trailHeads=new Uint16Array(MAX_PARTICLES);
const TRAIL_LENGTH=20;
let sourceData=null,sourceWidth=0,sourceHeight=0,canvasWidth=1280,canvasHeight=720,camRotX=0.3,camRotY=0,isDragging=false,lastMouseX=0,lastMouseY=0,lastPinchDist=0,webcam=null,useWebcam=false,frameCount=0,lastTime=performance.now(),fps=0,hintInteracted=false,brightnessSamples=[],brightnessSamplerReady=false,mediaRecorder=null,recordedChunks=[];
let cameraFacingMode='user';
let swipeStartX=0,swipeStartY=0,isSwiping=false;
let edgeData=null,edgeFieldData=null,prevEdgeData=null;

function hash2(a,b){let x=(a*374761393+b*668265263)|0;x=((x>>>16)^x)*0x45d9f3b|0;x=((x>>>16)^x)*0x45d9f3b|0;return(x>>>16)^x;}
const hashFloat2=(a,b)=>(hash2(a,b)>>>0)/4294967296;
const hashRange=(a,b,min,max)=>min+hashFloat2(a,b)*(max-min);
const hashFluct=(a,b)=>(hash2(a,b)%257)-128;
function hexToRgb(h){const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:{r:255,g:255,b:255};}
function showToast(m){const t=document.getElementById('toast');document.getElementById('toastMessage').textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);}
function showFlash(){const f=document.getElementById('flashOverlay');f.classList.remove('flash');void f.offsetWidth;f.classList.add('flash');}
function playSound(){try{const c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=1800;o.type='square';g.gain.setValueAtTime(0.2,c.currentTime);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+0.04);o.start();o.stop(c.currentTime+0.04);}catch(e){}}

function perspectiveMatrix(fov,a,n,f){const t=1/Math.tan(fov*Math.PI/360),nf=1/(n-f);return new Float32Array([t/a,0,0,0,0,t,0,0,0,0,(f+n)*nf,-1,0,0,2*f*n*nf,0]);}
function orthoMatrix(l,r,b,t,n,f){return new Float32Array([2/(r-l),0,0,0,0,2/(t-b),0,0,0,0,-2/(f-n),0,-(r+l)/(r-l),-(t+b)/(t-b),-(f+n)/(f-n),1]);}
function viewMatrix(rx,ry,d){const cx=Math.cos(rx),sx=Math.sin(rx),cy=Math.cos(ry),sy=Math.sin(ry);return new Float32Array([cy,sx*sy,-cx*sy,0,0,cx,sx,0,sy,-sx*cy,cx*cy,0,0,0,-d,1]);}
const identityMatrix=()=>new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);

const vsSource=`attribute vec3 aPosition;attribute vec4 aColor;attribute float aSize;uniform mat4 uProjection,uView;uniform vec2 uResolution;uniform float uIs3D;varying vec4 vColor;void main(){vec4 vp=uView*vec4(aPosition,1.0);gl_Position=uProjection*vp;gl_PointSize=uIs3D>0.5?clamp(aSize*(uResolution.y/length(vp.xyz))*0.5,1.0,100.0):aSize;vColor=aColor;}`;
const fsSource=`precision mediump float;varying vec4 vColor;void main(){vec2 c=gl_PointCoord-0.5;float d=length(c);if(d>0.5)discard;gl_FragColor=vec4(vColor.rgb,smoothstep(0.5,0.2,d)*vColor.a);}`;
const lineVsSource=`attribute vec3 aPosition;attribute vec4 aColor;uniform mat4 uProjection,uView;varying vec4 vColor;void main(){gl_Position=uProjection*uView*vec4(aPosition,1.0);vColor=aColor;}`;
const lineFsSource=`precision mediump float;varying vec4 vColor;void main(){gl_FragColor=vColor;}`;
const blurVsSource=`attribute vec2 aPosition;varying vec2 vUv;void main(){vUv=aPosition*0.5+0.5;gl_Position=vec4(aPosition,0.0,1.0);}`;
const blurFsSource=`precision mediump float;uniform sampler2D uTexture;uniform vec2 uDirection,uResolution;varying vec2 vUv;void main(){vec4 c=vec4(0.0);vec2 off=uDirection/uResolution;c+=texture2D(uTexture,vUv-off*3.0)*0.06;c+=texture2D(uTexture,vUv-off*2.0)*0.12;c+=texture2D(uTexture,vUv-off)*0.18;c+=texture2D(uTexture,vUv)*0.28;c+=texture2D(uTexture,vUv+off)*0.18;c+=texture2D(uTexture,vUv+off*2.0)*0.12;c+=texture2D(uTexture,vUv+off*3.0)*0.06;gl_FragColor=c;}`;
const compositeVsSource=`attribute vec2 aPosition;varying vec2 vUv;void main(){vUv=aPosition*0.5+0.5;gl_Position=vec4(aPosition,0.0,1.0);}`;
const compositeFsSource=`precision mediump float;uniform sampler2D uOriginal,uGlow;uniform float uIntensity;varying vec2 vUv;void main(){gl_FragColor=texture2D(uOriginal,vUv)+texture2D(uGlow,vUv)*uIntensity;}`;

function createShader(gl,type,source){const s=gl.createShader(type);gl.shaderSource(s,source);gl.compileShader(s);return s;}
function createProgram(gl,vs,fs){const p=gl.createProgram();gl.attachShader(p,vs);gl.attachShader(p,fs);gl.linkProgram(p);return p;}
function createFramebuffer(gl,w,h){const fb=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,fb);const tex=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,tex);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,w,h,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,tex,0);gl.bindFramebuffer(gl.FRAMEBUFFER,null);return{framebuffer:fb,texture:tex};}

function initGlowResources(){const w=canvasWidth,h=canvasHeight;const m=createFramebuffer(gl,w,h);framebufferMain=m.framebuffer;textureMain=m.texture;const a=createFramebuffer(gl,w/2,h/2);framebufferA=a.framebuffer;textureA=a.texture;const b=createFramebuffer(gl,w/2,h/2);framebufferB=b.framebuffer;textureB=b.texture;quadBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,quadBuffer);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),gl.STATIC_DRAW);glowProgram=createProgram(gl,createShader(gl,gl.VERTEX_SHADER,blurVsSource),createShader(gl,gl.FRAGMENT_SHADER,blurFsSource));compositeProgram=createProgram(gl,createShader(gl,gl.VERTEX_SHADER,compositeVsSource),createShader(gl,gl.FRAGMENT_SHADER,compositeFsSource));
// Cache locations
glowLocs={uTex:gl.getUniformLocation(glowProgram,'uTexture'),uDir:gl.getUniformLocation(glowProgram,'uDirection'),uRes:gl.getUniformLocation(glowProgram,'uResolution'),aPos:gl.getAttribLocation(glowProgram,'aPosition')};
compositeLocs={uOrig:gl.getUniformLocation(compositeProgram,'uOriginal'),uGlow:gl.getUniformLocation(compositeProgram,'uGlow'),uInt:gl.getUniformLocation(compositeProgram,'uIntensity'),aPos:gl.getAttribLocation(compositeProgram,'aPosition')};}

function resizeGlowResources(){if(!gl)return;const w=canvasWidth,h=canvasHeight;gl.bindTexture(gl.TEXTURE_2D,textureMain);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,w,h,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindTexture(gl.TEXTURE_2D,textureA);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,w/2,h/2,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindTexture(gl.TEXTURE_2D,textureB);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,w/2,h/2,0,gl.RGBA,gl.UNSIGNED_BYTE,null);}

function initWebGL(){canvas=document.getElementById('glCanvas');canvas.width=canvasWidth;canvas.height=canvasHeight;gl=canvas.getContext('webgl',{alpha:true,antialias:true,preserveDrawingBuffer:true});if(!gl)return false;program=createProgram(gl,createShader(gl,gl.VERTEX_SHADER,vsSource),createShader(gl,gl.FRAGMENT_SHADER,fsSource));lineProgram=createProgram(gl,createShader(gl,gl.VERTEX_SHADER,lineVsSource),createShader(gl,gl.FRAGMENT_SHADER,lineFsSource));positionBuffer=gl.createBuffer();colorBuffer=gl.createBuffer();sizeBuffer=gl.createBuffer();gl.enable(gl.BLEND);gl.useProgram(program);uProjection=gl.getUniformLocation(program,'uProjection');uView=gl.getUniformLocation(program,'uView');uResolution=gl.getUniformLocation(program,'uResolution');uIs3D=gl.getUniformLocation(program,'uIs3D');
// Cache main program locations
mainLocs={aPos:gl.getAttribLocation(program,'aPosition'),aCol:gl.getAttribLocation(program,'aColor'),aSiz:gl.getAttribLocation(program,'aSize')};
// Cache line program locations
lineLocs={uProj:gl.getUniformLocation(lineProgram,'uProjection'),uView:gl.getUniformLocation(lineProgram,'uView'),aPos:gl.getAttribLocation(lineProgram,'aPosition'),aCol:gl.getAttribLocation(lineProgram,'aColor')};
initGlowResources();return true;}

function getSourcePixel(x,y){if(!sourceData)return{r:128,g:128,b:128};const sx=Math.floor((x/canvasWidth)*sourceWidth),sy=Math.floor(((canvasHeight-y)/canvasHeight)*sourceHeight),idx=(Math.max(0,Math.min(sourceHeight-1,sy))*sourceWidth+Math.max(0,Math.min(sourceWidth-1,sx)))*4;return{r:sourceData[idx],g:sourceData[idx+1],b:sourceData[idx+2]};}
function getBrightness(x,y){const p=getSourcePixel(x,y);return 0.2126*p.r+0.7152*p.g+0.0722*p.b;}
function buildBrightnessSampler(){if(!sourceData)return;brightnessSamples=[];const step=Math.max(1,Math.floor(Math.min(sourceWidth,sourceHeight)/128)),thresh=settings.cutoff*2.55;for(let y=0;y<sourceHeight;y+=step)for(let x=0;x<sourceWidth;x+=step){const idx=(y*sourceWidth+x)*4,br=0.2126*sourceData[idx]+0.7152*sourceData[idx+1]+0.0722*sourceData[idx+2];if(br>=thresh)brightnessSamples.push({x:(x/sourceWidth)*canvasWidth,y:(y/sourceHeight)*canvasHeight});}brightnessSamplerReady=brightnessSamples.length>0;}

function computeEdgeMap(){
  if(!sourceData)return;
  const w=sourceWidth,h=sourceHeight,method=settings.edgeMethod||1;
  const gray=new Float32Array(w*h);
  for(let i=0;i<w*h;i++){const idx=i*4;gray[i]=0.2126*sourceData[idx]+0.7152*sourceData[idx+1]+0.0722*sourceData[idx+2];}
  function gaussianBlur(src,r){if(r<1)return src;const dst=new Float32Array(w*h),kernel=[];let sum=0;for(let i=-r;i<=r;i++){const v=Math.exp(-(i*i)/(2*(r/2)*(r/2)));kernel.push(v);sum+=v;}for(let i=0;i<kernel.length;i++)kernel[i]/=sum;const tmp=new Float32Array(w*h);for(let y=0;y<h;y++)for(let x=0;x<w;x++){let v=0;for(let k=-r;k<=r;k++){const xx=Math.max(0,Math.min(w-1,x+k));v+=src[y*w+xx]*kernel[k+r];}tmp[y*w+x]=v;}for(let y=0;y<h;y++)for(let x=0;x<w;x++){let v=0;for(let k=-r;k<=r;k++){const yy=Math.max(0,Math.min(h-1,y+k));v+=tmp[yy*w+x]*kernel[k+r];}dst[y*w+x]=v;}return dst;}
  function sobel(src){const mag=new Float32Array(w*h);let maxMag=0;for(let y=1;y<h-1;y++)for(let x=1;x<w-1;x++){const idx=y*w+x,gx=-src[(y-1)*w+(x-1)]-2*src[y*w+(x-1)]-src[(y+1)*w+(x-1)]+src[(y-1)*w+(x+1)]+2*src[y*w+(x+1)]+src[(y+1)*w+(x+1)],gy=-src[(y-1)*w+(x-1)]-2*src[(y-1)*w+x]-src[(y-1)*w+(x+1)]+src[(y+1)*w+(x-1)]+2*src[(y+1)*w+x]+src[(y+1)*w+(x+1)],m=Math.sqrt(gx*gx+gy*gy);mag[idx]=m;if(m>maxMag)maxMag=m;}if(maxMag>0)for(let i=0;i<w*h;i++)mag[i]/=maxMag;return mag;}
  edgeData=new Float32Array(w*h);
  if(method===1){edgeData=sobel(gaussianBlur(gray,1));}
  else{const blurred=gaussianBlur(gray,2),mag=sobel(blurred);for(let i=0;i<w*h;i++)edgeData[i]=mag[i]>0.1?mag[i]:mag[i]*0.3;}
  if(prevEdgeData&&prevEdgeData.length===edgeData.length){const blend=0.3;for(let i=0;i<edgeData.length;i++)edgeData[i]=edgeData[i]*blend+prevEdgeData[i]*(1-blend);}
  prevEdgeData=new Float32Array(edgeData);
  edgeFieldData=gaussianBlur(edgeData,8);
}

function getEdgeStrength(x,y){if(!edgeData)return 0;const sx=Math.floor((x/canvasWidth)*sourceWidth),sy=Math.floor(((canvasHeight-y)/canvasHeight)*sourceHeight),idx=Math.max(0,Math.min(sourceHeight-1,sy))*sourceWidth+Math.max(0,Math.min(sourceWidth-1,sx));return edgeData[idx]||0;}

function getEdgeGradient(x,y){const field=edgeFieldData||edgeData;if(!field)return{gx:0,gy:0};const step=2;function sample(px,py){const sx=Math.floor((px/canvasWidth)*sourceWidth),sy=Math.floor(((canvasHeight-py)/canvasHeight)*sourceHeight),idx=Math.max(0,Math.min(sourceHeight-1,sy))*sourceWidth+Math.max(0,Math.min(sourceWidth-1,sx));return field[idx]||0;}const eR=sample(x+step,y),eL=sample(x-step,y),eU=sample(x,y-step),eD=sample(x,y+step);let gx=(eR-eL)*0.5,gy=(eD-eU)*0.5;const len=Math.sqrt(gx*gx+gy*gy);if(len>0.001){gx/=len;gy/=len;}return{gx,gy};}

function spawnParticle(index){const key=settings.seed*100000+frameCount*1000+index,pId=particleIdCounter++;let sx,sy;if(settings.spawnType===2&&brightnessSamplerReady){const s=brightnessSamples[Math.floor(hashFloat2(key,100)*brightnessSamples.length)];sx=s.x;sy=s.y;}else{sx=hashRange(key,1,0,canvasWidth);sy=hashRange(key,2,0,canvasHeight);}const br=getBrightness(sx,sy),x=sx-canvasWidth/2,y=sy-canvasHeight/2;let z=0;if(settings.mode>=4){if(settings.spawn3DMode===2)z=(br/255-0.5)*settings.depthScale*2;else if(settings.spawn3DMode===3)z=hashRange(key,3,-settings.depthScale,settings.depthScale);}const pixel=getSourcePixel(sx,sy),nf=Math.round(settings.fluct*0.708),lf=nf>0?Math.floor(hashFluct(pId,2)*nf/128):0,spd=settings.speed*(0.5+hashFloat2(key,4)*0.5);let vx,vy,vz=0;if(settings.dir3DSource===2&&settings.mode>=4){vx=(pixel.r/127.5-1)*spd;vy=(pixel.g/127.5-1)*spd;vz=(pixel.b/127.5-1)*spd;}else{const ch=settings.channel===1?br:pixel.r,ang=(ch/255)*Math.PI*2+settings.shift*Math.PI/180+lf*Math.PI/180;vx=Math.cos(ang)*spd;vy=Math.sin(ang)*spd;}const i3=particleCount*3,i4=particleCount*4;positions[i3]=x;positions[i3+1]=y;positions[i3+2]=z;origPositions[i3]=x;origPositions[i3+1]=y;origPositions[i3+2]=z;velocities[i3]=vx;velocities[i3+1]=vy;velocities[i3+2]=vz;particleFluct[particleCount]=lf;particleIds[particleCount]=pId;particleSpeeds[particleCount]=spd;const cm=settings.colorMode;if(cm===1||cm===2){colors[i4]=pixel.r/255;colors[i4+1]=pixel.g/255;colors[i4+2]=pixel.b/255;}else if(cm===3){const c=hexToRgb(settings.customColor);colors[i4]=c.r/255;colors[i4+1]=c.g/255;colors[i4+2]=c.b/255;}else{const c=hexToRgb(settings.startColor);colors[i4]=c.r/255;colors[i4+1]=c.g/255;colors[i4+2]=c.b/255;}colors[i4+3]=1;sizes[particleCount]=settings.size;lifetimes[particleCount]=settings.lifetime;maxLifetimes[particleCount]=settings.lifetime;trailCounts[particleCount]=0;trailHeads[particleCount]=0;particleCount++;}

function updateParticles(){let wi=0;const ar=settings.attrAngle*Math.PI/180,ac=Math.cos(ar),as=Math.sin(ar);let g1=null,g2=null;if(settings.colorMode>=4){g1=hexToRgb(settings.startColor);g2=hexToRgb(settings.endColor);}const updateTrails=(settings.mode===5||settings.mode===3);const edgeOpacityMult=settings.edgeOpacity/100*0.8,edgeSizeMult=settings.edgeSize/100;for(let i=0;i<particleCount;i++){const i3=i*3,i4=i*4;if(--lifetimes[i]<=0)continue;const cx=positions[i3]+canvasWidth/2,cy=positions[i3+1]+canvasHeight/2,spd=particleSpeeds[i];if(settings.dir3DSource===2&&settings.mode>=4){const p=getSourcePixel(cx,cy);velocities[i3]=(p.r/127.5-1)*spd;velocities[i3+1]=(p.g/127.5-1)*spd;velocities[i3+2]=(p.b/127.5-1)*spd;}else{const p=getSourcePixel(cx,cy),br=0.2126*p.r+0.7152*p.g+0.0722*p.b,ch=settings.channel===1?br:p.r;let df=0;if(settings.dynFluct>0)df=Math.floor(hashFluct(particleIds[i]*10000+(maxLifetimes[i]-lifetimes[i]),3)*Math.round(settings.dynFluct*0.708)/128);const ang=(ch/255)*Math.PI*2+settings.shift*Math.PI/180+particleFluct[i]*Math.PI/180+df*Math.PI/180;velocities[i3]=Math.cos(ang)*spd;velocities[i3+1]=Math.sin(ang)*spd;}if(settings.attrForce!==0){velocities[i3]+=ac*settings.attrForce*0.1;velocities[i3+1]+=as*settings.attrForce*0.1;}if(settings.edgeAttr>0){const eg=getEdgeGradient(cx,cy),ef=settings.edgeAttr*0.015;velocities[i3]+=eg.gx*ef;velocities[i3+1]-=eg.gy*ef;}if(settings.imgAttr>0&&settings.mode>=4){const s=settings.imgAttr*0.001;velocities[i3]+=(origPositions[i3]-positions[i3])*s;velocities[i3+1]+=(origPositions[i3+1]-positions[i3+1])*s;velocities[i3+2]+=(origPositions[i3+2]-positions[i3+2])*s;}const edge=getEdgeStrength(cx,cy),edgeAlpha=edgeOpacityMult>0?(0.02+edge*0.98)*edgeOpacityMult+(1-edgeOpacityMult):1,edgeSize=settings.size*(1+edge*edgeSizeMult*3.5);if(updateTrails){const tb=i*TRAIL_LENGTH,head=trailHeads[i],ti=tb+head;trailPositions[ti*3]=positions[i3];trailPositions[ti*3+1]=positions[i3+1];trailPositions[ti*3+2]=positions[i3+2];trailColors[ti*4]=colors[i4];trailColors[ti*4+1]=colors[i4+1];trailColors[ti*4+2]=colors[i4+2];trailColors[ti*4+3]=edgeAlpha;trailSizes[ti]=edgeSize;trailHeads[i]=(head+1)%TRAIL_LENGTH;if(trailCounts[i]<TRAIL_LENGTH)trailCounts[i]++;}positions[i3]+=velocities[i3];positions[i3+1]+=velocities[i3+1];positions[i3+2]+=velocities[i3+2];const hw=canvasWidth/2*1.5,hh=canvasHeight/2*1.5,md=settings.depthScale*2;if(Math.abs(positions[i3])>hw||Math.abs(positions[i3+1])>hh||Math.abs(positions[i3+2])>md)continue;const lr=lifetimes[i]/maxLifetimes[i];colors[i4+3]=lr*edgeAlpha;sizes[i]=edgeSize;if(settings.colorMode===2){const p=getSourcePixel(cx,cy);colors[i4]=p.r/255;colors[i4+1]=p.g/255;colors[i4+2]=p.b/255;}else if(settings.colorMode===4){const t=1-lr;colors[i4]=(g1.r+(g2.r-g1.r)*t)/255;colors[i4+1]=(g1.g+(g2.g-g1.g)*t)/255;colors[i4+2]=(g1.b+(g2.b-g1.b)*t)/255;}else if(settings.colorMode===5){const t=Math.max(0,Math.min(1,(positions[i3+2]+settings.depthScale)/(settings.depthScale*2)));colors[i4]=(g1.r+(g2.r-g1.r)*t)/255;colors[i4+1]=(g1.g+(g2.g-g1.g)*t)/255;colors[i4+2]=(g1.b+(g2.b-g1.b)*t)/255;}if(wi!==i){const w3=wi*3,w4=wi*4;positions[w3]=positions[i3];positions[w3+1]=positions[i3+1];positions[w3+2]=positions[i3+2];origPositions[w3]=origPositions[i3];origPositions[w3+1]=origPositions[i3+1];origPositions[w3+2]=origPositions[i3+2];velocities[w3]=velocities[i3];velocities[w3+1]=velocities[i3+1];velocities[w3+2]=velocities[i3+2];colors[w4]=colors[i4];colors[w4+1]=colors[i4+1];colors[w4+2]=colors[i4+2];colors[w4+3]=colors[i4+3];sizes[wi]=sizes[i];lifetimes[wi]=lifetimes[i];maxLifetimes[wi]=maxLifetimes[i];particleFluct[wi]=particleFluct[i];particleIds[wi]=particleIds[i];particleSpeeds[wi]=particleSpeeds[i];const stb=i*TRAIL_LENGTH,dtb=wi*TRAIL_LENGTH;for(let t=0;t<TRAIL_LENGTH;t++){trailPositions[(dtb+t)*3]=trailPositions[(stb+t)*3];trailPositions[(dtb+t)*3+1]=trailPositions[(stb+t)*3+1];trailPositions[(dtb+t)*3+2]=trailPositions[(stb+t)*3+2];trailColors[(dtb+t)*4]=trailColors[(stb+t)*4];trailColors[(dtb+t)*4+1]=trailColors[(stb+t)*4+1];trailColors[(dtb+t)*4+2]=trailColors[(stb+t)*4+2];trailColors[(dtb+t)*4+3]=trailColors[(stb+t)*4+3];trailSizes[dtb+t]=trailSizes[stb+t];}trailCounts[wi]=trailCounts[i];trailHeads[wi]=trailHeads[i];}wi++;}particleCount=wi;}

function renderParticles(toFB){const colorKey=settings.bgColor;if(cachedColors.bg!==colorKey){cachedColors.bg=colorKey;cachedColors.bgRgb=hexToRgb(colorKey);}const bg=cachedColors.bgRgb;if(toFB){gl.bindFramebuffer(gl.FRAMEBUFFER,framebufferMain);gl.viewport(0,0,canvasWidth,canvasHeight);}gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.clearColor(settings.transparentBg?0:bg.r/255,settings.transparentBg?0:bg.g/255,settings.transparentBg?0:bg.b/255,settings.transparentBg?0:(settings.mode===3||settings.mode===5)&&settings.fade>0?settings.fade/255:1);gl.clear(gl.COLOR_BUFFER_BIT);if(particleCount===0)return;gl.useProgram(program);let proj,view;if(settings.mode>=4){proj=perspectiveMatrix(settings.fov,canvasWidth/canvasHeight,1,5000);view=viewMatrix(camRotX,camRotY,settings.camDist);}else{proj=orthoMatrix(-canvasWidth/2,canvasWidth/2,-canvasHeight/2,canvasHeight/2,-1000,1000);view=identityMatrix();}gl.uniformMatrix4fv(uProjection,false,proj);gl.uniformMatrix4fv(uView,false,view);gl.uniform2f(uResolution,canvasWidth,canvasHeight);gl.uniform1f(uIs3D,settings.mode>=4?1:0);if(settings.mode!==3){gl.bindBuffer(gl.ARRAY_BUFFER,positionBuffer);gl.bufferData(gl.ARRAY_BUFFER,positions.subarray(0,particleCount*3),gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(mainLocs.aPos);gl.vertexAttribPointer(mainLocs.aPos,3,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,colorBuffer);gl.bufferData(gl.ARRAY_BUFFER,colors.subarray(0,particleCount*4),gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(mainLocs.aCol);gl.vertexAttribPointer(mainLocs.aCol,4,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,sizeBuffer);gl.bufferData(gl.ARRAY_BUFFER,sizes.subarray(0,particleCount),gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(mainLocs.aSiz);gl.vertexAttribPointer(mainLocs.aSiz,1,gl.FLOAT,false,0,0);gl.drawArrays(gl.POINTS,0,particleCount);}if(settings.mode===3||settings.mode===5)renderTrails(proj,view);if(toFB)gl.bindFramebuffer(gl.FRAMEBUFFER,null);}

function applyGlow(){const hw=canvasWidth/2,hh=canvasHeight/2;gl.useProgram(glowProgram);gl.bindBuffer(gl.ARRAY_BUFFER,quadBuffer);gl.enableVertexAttribArray(glowLocs.aPos);gl.vertexAttribPointer(glowLocs.aPos,2,gl.FLOAT,false,0,0);gl.disable(gl.BLEND);for(let p=0;p<2;p++){const spread=(p+1)*settings.glowRadius/2;gl.bindFramebuffer(gl.FRAMEBUFFER,framebufferA);gl.viewport(0,0,hw,hh);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,p===0?textureMain:textureB);gl.uniform1i(glowLocs.uTex,0);gl.uniform2f(glowLocs.uDir,spread,0);gl.uniform2f(glowLocs.uRes,hw,hh);gl.drawArrays(gl.TRIANGLE_STRIP,0,4);gl.bindFramebuffer(gl.FRAMEBUFFER,framebufferB);gl.bindTexture(gl.TEXTURE_2D,textureA);gl.uniform2f(glowLocs.uDir,0,spread);gl.drawArrays(gl.TRIANGLE_STRIP,0,4);}gl.enable(gl.BLEND);}

function compositeGlow(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(0,0,canvasWidth,canvasHeight);gl.useProgram(compositeProgram);gl.bindBuffer(gl.ARRAY_BUFFER,quadBuffer);gl.enableVertexAttribArray(compositeLocs.aPos);gl.vertexAttribPointer(compositeLocs.aPos,2,gl.FLOAT,false,0,0);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,textureMain);gl.uniform1i(compositeLocs.uOrig,0);gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,textureB);gl.uniform1i(compositeLocs.uGlow,1);gl.uniform1f(compositeLocs.uInt,settings.glowIntensity);gl.blendFunc(gl.ONE,gl.ZERO);gl.drawArrays(gl.TRIANGLE_STRIP,0,4);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);}

function render(){if(settings.glowEnabled&&particleCount>0){renderParticles(true);applyGlow();compositeGlow();}else{renderParticles(false);}}

// Reusable trail buffers
const TRAIL_BUF_MAX=MAX_PARTICLES*TRAIL_LENGTH*6;
let trailTriPos=new Float32Array(TRAIL_BUF_MAX*3),trailTriCol=new Float32Array(TRAIL_BUF_MAX*4);
function renderTrails(proj,view){if(particleCount===0||!lineProgram)return;let segCount=0;for(let i=0;i<particleCount;i++)if(trailCounts[i]>1)segCount+=trailCounts[i]-1;if(segCount===0)return;let vi=0;for(let i=0;i<particleCount;i++){const c=trailCounts[i];if(c<2)continue;const tb=i*TRAIL_LENGTH,head=trailHeads[i];for(let j=0;j<c-1;j++){const idx1=tb+((head-c+j+TRAIL_LENGTH)%TRAIL_LENGTH),idx2=tb+((head-c+j+1+TRAIL_LENGTH)%TRAIL_LENGTH);const x1=trailPositions[idx1*3],y1=trailPositions[idx1*3+1],z1=trailPositions[idx1*3+2],x2=trailPositions[idx2*3],y2=trailPositions[idx2*3+1],z2=trailPositions[idx2*3+2];const dx=x2-x1,dy=y2-y1,len=Math.sqrt(dx*dx+dy*dy)||1;const t1=trailSizes[idx1]*0.25,t2=trailSizes[idx2]*0.25,nx1=-dy/len*t1,ny1=dx/len*t1,nx2=-dy/len*t2,ny2=dx/len*t2;const fp1=((j+1)/c)*0.9,fp2=((j+2)/c)*0.9,a1=trailColors[idx1*4+3]*fp1,a2=trailColors[idx2*4+3]*fp2;const r1=trailColors[idx1*4],g1=trailColors[idx1*4+1],b1=trailColors[idx1*4+2],r2=trailColors[idx2*4],g2_=trailColors[idx2*4+1],b2=trailColors[idx2*4+2];trailTriPos[vi*3]=x1+nx1;trailTriPos[vi*3+1]=y1+ny1;trailTriPos[vi*3+2]=z1;trailTriCol[vi*4]=r1;trailTriCol[vi*4+1]=g1;trailTriCol[vi*4+2]=b1;trailTriCol[vi*4+3]=a1;vi++;trailTriPos[vi*3]=x1-nx1;trailTriPos[vi*3+1]=y1-ny1;trailTriPos[vi*3+2]=z1;trailTriCol[vi*4]=r1;trailTriCol[vi*4+1]=g1;trailTriCol[vi*4+2]=b1;trailTriCol[vi*4+3]=a1;vi++;trailTriPos[vi*3]=x2+nx2;trailTriPos[vi*3+1]=y2+ny2;trailTriPos[vi*3+2]=z2;trailTriCol[vi*4]=r2;trailTriCol[vi*4+1]=g2_;trailTriCol[vi*4+2]=b2;trailTriCol[vi*4+3]=a2;vi++;trailTriPos[vi*3]=x2+nx2;trailTriPos[vi*3+1]=y2+ny2;trailTriPos[vi*3+2]=z2;trailTriCol[vi*4]=r2;trailTriCol[vi*4+1]=g2_;trailTriCol[vi*4+2]=b2;trailTriCol[vi*4+3]=a2;vi++;trailTriPos[vi*3]=x1-nx1;trailTriPos[vi*3+1]=y1-ny1;trailTriPos[vi*3+2]=z1;trailTriCol[vi*4]=r1;trailTriCol[vi*4+1]=g1;trailTriCol[vi*4+2]=b1;trailTriCol[vi*4+3]=a1;vi++;trailTriPos[vi*3]=x2-nx2;trailTriPos[vi*3+1]=y2-ny2;trailTriPos[vi*3+2]=z2;trailTriCol[vi*4]=r2;trailTriCol[vi*4+1]=g2_;trailTriCol[vi*4+2]=b2;trailTriCol[vi*4+3]=a2;vi++;}}gl.useProgram(lineProgram);gl.uniformMatrix4fv(lineLocs.uProj,false,proj);gl.uniformMatrix4fv(lineLocs.uView,false,view);gl.bindBuffer(gl.ARRAY_BUFFER,positionBuffer);gl.bufferData(gl.ARRAY_BUFFER,trailTriPos.subarray(0,vi*3),gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(lineLocs.aPos);gl.vertexAttribPointer(lineLocs.aPos,3,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,colorBuffer);gl.bufferData(gl.ARRAY_BUFFER,trailTriCol.subarray(0,vi*4),gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(lineLocs.aCol);gl.vertexAttribPointer(lineLocs.aCol,4,gl.FLOAT,false,0,0);gl.drawArrays(gl.TRIANGLES,0,vi);gl.useProgram(program);}

function renderStaticTrails(){// Cache colors
const colorKey=settings.bgColor+settings.startColor+settings.endColor+settings.customColor;
if(cachedColors.key!==colorKey){cachedColors.key=colorKey;cachedColors.bg=hexToRgb(settings.bgColor);cachedColors.g1=hexToRgb(settings.startColor);cachedColors.g2=hexToRgb(settings.endColor);cachedColors.cc=hexToRgb(settings.customColor);}
const bg=cachedColors.bg,g1=cachedColors.g1,g2=cachedColors.g2,cc=cachedColors.cc;
if(settings.glowEnabled){gl.bindFramebuffer(gl.FRAMEBUFFER,framebufferMain);gl.viewport(0,0,canvasWidth,canvasHeight);}gl.clearColor(settings.transparentBg?0:bg.r/255,settings.transparentBg?0:bg.g/255,settings.transparentBg?0:bg.b/255,settings.transparentBg?0:1);gl.clear(gl.COLOR_BUFFER_BIT);gl.useProgram(program);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.uniformMatrix4fv(uProjection,false,orthoMatrix(-canvasWidth/2,canvasWidth/2,-canvasHeight/2,canvasHeight/2,-1000,1000));gl.uniformMatrix4fv(uView,false,identityMatrix());gl.uniform2f(uResolution,canvasWidth,canvasHeight);gl.uniform1f(uIs3D,0);
// Pre-compute invariants
const ar=settings.attrAngle*Math.PI/180,ac=Math.cos(ar),as=Math.sin(ar),maxSteps=Math.floor(settings.lifetime*settings.speed),edgeOpacityMult=settings.edgeOpacity/100*0.8,edgeSizeMult=settings.edgeSize/100,edgeAttrF=settings.edgeAttr*0.015,shiftRad=settings.shift*Math.PI/180,nf=Math.round(settings.fluct*0.708),dynFluctNf=Math.round(settings.dynFluct*0.708),useEdgeAttr=edgeAttrF>0,useDynFluct=settings.dynFluct>0,useAttrForce=settings.attrForce!==0,attrFX=ac*settings.attrForce*0.1,attrFY=as*settings.attrForce*0.1,cm=settings.colorMode,hwC=canvasWidth/2,hhC=canvasHeight/2,g1r=g1.r,g1g=g1.g,g1b=g1.b,g2r=g2.r-g1r,g2g=g2.g-g1g,g2b=g2.b-g1b,ccr=cc.r/255,ccg=cc.g/255,ccb=cc.b/255,baseSize=settings.size,sizeMult=edgeSizeMult*3.5;
let pi=0;
for(let i=0;i<settings.count&&pi<STATIC_MAX;i++){const key=settings.seed*10000+i;let sx,sy;if(settings.spawnType===2&&brightnessSamplerReady){const s=brightnessSamples[Math.floor(hashFloat2(key,100)*brightnessSamples.length)];sx=s.x;sy=s.y;}else{sx=hashRange(key,1,0,canvasWidth);sy=hashRange(key,2,0,canvasHeight);}let x=sx-hwC,y=sy-hhC;const sp=getSourcePixel(sx,sy),spr=sp.r/255,spg=sp.g/255,spb=sp.b/255,spd=settings.speed*(0.5+hashFloat2(key,3)*0.5),lf=nf>0?(hashFluct(key,2)*nf/128)|0:0,lfRad=lf*Math.PI/180;
for(let step=0;step<maxSteps&&pi<STATIC_MAX;step++){const cx=x+hwC,cy=y+hhC;if(cx<0||cx>=canvasWidth||cy<0||cy>=canvasHeight)break;const p=getSourcePixel(cx,cy),br=0.2126*p.r+0.7152*p.g+0.0722*p.b,ch=settings.channel===1?br:p.r;let df=0;if(useDynFluct)df=(hashFluct(key*10000+step,3)*dynFluctNf/128)|0;const ang=(ch/255)*6.283185307+shiftRad+lfRad+df*Math.PI/180;const edge=getEdgeStrength(cx,cy),edgeAlpha=edgeOpacityMult>0?(0.02+edge*0.98)*edgeOpacityMult+(1-edgeOpacityMult):1,edgeSize=baseSize*(1+edge*sizeMult);const pi3=pi*3,pi4=pi*4;staticPos[pi3]=x;staticPos[pi3+1]=y;staticPos[pi3+2]=0;const t=step/maxSteps;if(cm===1){staticCol[pi4]=spr;staticCol[pi4+1]=spg;staticCol[pi4+2]=spb;}else if(cm===2){staticCol[pi4]=p.r/255;staticCol[pi4+1]=p.g/255;staticCol[pi4+2]=p.b/255;}else if(cm===4){staticCol[pi4]=(g1r+g2r*t)/255;staticCol[pi4+1]=(g1g+g2g*t)/255;staticCol[pi4+2]=(g1b+g2b*t)/255;}else{staticCol[pi4]=ccr;staticCol[pi4+1]=ccg;staticCol[pi4+2]=ccb;}staticCol[pi4+3]=(1-t)*edgeAlpha;staticSiz[pi]=edgeSize;pi++;let vx=Math.cos(ang)*spd,vy=Math.sin(ang)*spd;if(useAttrForce){vx+=attrFX;vy+=attrFY;}if(useEdgeAttr){const eg=getEdgeGradient(cx,cy);vx+=eg.gx*edgeAttrF;vy-=eg.gy*edgeAttrF;}x+=vx;y+=vy;}}
gl.bindBuffer(gl.ARRAY_BUFFER,positionBuffer);gl.bufferData(gl.ARRAY_BUFFER,staticPos.subarray(0,pi*3),gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(mainLocs.aPos);gl.vertexAttribPointer(mainLocs.aPos,3,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,colorBuffer);gl.bufferData(gl.ARRAY_BUFFER,staticCol.subarray(0,pi*4),gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(mainLocs.aCol);gl.vertexAttribPointer(mainLocs.aCol,4,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,sizeBuffer);gl.bufferData(gl.ARRAY_BUFFER,staticSiz.subarray(0,pi),gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(mainLocs.aSiz);gl.vertexAttribPointer(mainLocs.aSiz,1,gl.FLOAT,false,0,0);gl.drawArrays(gl.POINTS,0,pi);if(settings.glowEnabled){gl.bindFramebuffer(gl.FRAMEBUFFER,null);applyGlow();compositeGlow();}}

function mainLoop(){frameCount++;const now=performance.now();if(now-lastTime>=500){fps=Math.round(frameCount/((now-lastTime)/1000));document.getElementById('fpsDisplay').textContent=fps;document.getElementById('particleCount').textContent=particleCount;document.getElementById('mobileFps').textContent=fps;document.getElementById('mobileParticleCount').textContent=particleCount;frameCount=0;lastTime=now;}if(useWebcam)updateFromWebcam();if(settings.mode===2){renderStaticTrails();}else{const spawn=Math.min(settings.count,MAX_PARTICLES-particleCount);for(let i=0;i<spawn;i++)spawnParticle(i);updateParticles();render();}requestAnimationFrame(mainLoop);}

function noiseHash(x,y,s){return(Math.sin(x*12.9898+y*78.233+s)*43758.5453)%1;}
function smoothNoise(x,y,s){const ix=Math.floor(x),iy=Math.floor(y),fx=x-ix,fy=y-iy,a=noiseHash(ix,iy,s),b=noiseHash(ix+1,iy,s),c=noiseHash(ix,iy+1,s),d=noiseHash(ix+1,iy+1,s),ux=fx*fx*(3-2*fx),uy=fy*fy*(3-2*fy);return a*(1-ux)*(1-uy)+b*ux*(1-uy)+c*(1-ux)*uy+d*ux*uy;}
function fractalNoise(x,y,s,o=4){let v=0,a=0.5,f=1,m=0;for(let i=0;i<o;i++){v+=smoothNoise(x*f,y*f,s+i*100)*a;m+=a;a*=0.5;f*=2;}return v/m;}
function createNoiseMap(){const w=512,h=288,d=new Uint8Array(w*h*4),sc=0.02;for(let y=0;y<h;y++)for(let x=0;x<w;x++){const i=(y*w+x)*4;d[i]=Math.floor(fractalNoise(x*sc,y*sc,settings.seed)*255);d[i+1]=Math.floor(fractalNoise(x*sc,y*sc,settings.seed+1000)*255);d[i+2]=Math.floor(fractalNoise(x*sc,y*sc,settings.seed+2000)*255);d[i+3]=255;}sourceData=d;sourceWidth=w;sourceHeight=h;computeEdgeMap();updateCanvasSize();updatePreview();}
function createGradientMap(){const w=512,h=288,d=new Uint8Array(w*h*4);for(let y=0;y<h;y++)for(let x=0;x<w;x++){const i=(y*w+x)*4,v=Math.floor((x/w)*255);d[i]=v;d[i+1]=v;d[i+2]=v;d[i+3]=255;}sourceData=d;sourceWidth=w;sourceHeight=h;computeEdgeMap();updateCanvasSize();updatePreview();}
function createRadialMap(){const w=512,h=288,d=new Uint8Array(w*h*4),cx=w/2,cy=h/2;for(let y=0;y<h;y++)for(let x=0;x<w;x++){const i=(y*w+x)*4,dx=x-cx,dy=y-cy,l=Math.sqrt(dx*dx+dy*dy)||1;d[i]=Math.floor((dx/l*0.5+0.5)*255);d[i+1]=Math.floor((dy/l*0.5+0.5)*255);d[i+2]=Math.floor(0.6*255);d[i+3]=255;}sourceData=d;sourceWidth=w;sourceHeight=h;computeEdgeMap();updateCanvasSize();updatePreview();}
function create3DFlowMap(){const w=512,h=288,d=new Uint8Array(w*h*4),cx=w/2,cy=h/2,md=Math.min(w,h)*0.5;for(let y=0;y<h;y++)for(let x=0;x<w;x++){const i=(y*w+x)*4,dx=x-cx,dy=y-cy,dist=Math.sqrt(dx*dx+dy*dy)/md,ang=Math.atan2(dy,dx),tx=-Math.sin(ang),ty=Math.cos(ang),turb=fractalNoise(x*0.02,y*0.02,settings.seed,3),zf=Math.sin(dist*4+settings.seed*0.1)*0.5;d[i]=Math.floor(((tx*0.7+(turb-0.5)*0.6)*0.5+0.5)*255);d[i+1]=Math.floor(((ty*0.7+(turb-0.5)*0.6)*0.5+0.5)*255);d[i+2]=Math.floor((zf*0.5+0.5)*255);d[i+3]=255;}sourceData=d;sourceWidth=w;sourceHeight=h;computeEdgeMap();updateCanvasSize();updatePreview();}
function updatePreview(){if(!sourceData)return;const c=document.createElement('canvas');c.width=sourceWidth;c.height=sourceHeight;const ctx=c.getContext('2d'),img=ctx.createImageData(sourceWidth,sourceHeight);img.data.set(sourceData);ctx.putImageData(img,0,0);const cont=document.getElementById('imagePreview');if(cont){cont.innerHTML='';const im=document.createElement('img');im.src=c.toDataURL();cont.appendChild(im);}}

async function startWebcam(facingMode='user'){try{if(webcam){webcam.srcObject?.getTracks().forEach(t=>t.stop());webcam=null;}const stream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:256},height:{ideal:256},facingMode:facingMode},audio:false});webcam=document.createElement('video');webcam.srcObject=stream;webcam.setAttribute('playsinline','');webcam.muted=true;await webcam.play();useWebcam=true;cameraFacingMode=facingMode;sourceWidth=256;sourceHeight=256;updateCanvasSize();document.getElementById('webcamBtn').classList.add('active');document.getElementById('webcamBtn').innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg> Active';document.getElementById('mobileWebcamBtn').classList.add('active');document.getElementById('mobileFlipCamBtn').style.display='flex';document.getElementById('imagePreview').innerHTML='<span>üì∑ Live</span>';return true;}catch(e){alert('Camera error: '+e.message);return false;}}
function stopWebcam(){if(webcam){webcam.srcObject?.getTracks().forEach(t=>t.stop());webcam=null;}useWebcam=false;document.getElementById('webcamBtn').classList.remove('active');document.getElementById('webcamBtn').innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg> Camera';document.getElementById('mobileWebcamBtn').classList.remove('active');document.getElementById('mobileFlipCamBtn').style.display='none';}
function flipCamera(){startWebcam(cameraFacingMode==='user'?'environment':'user');}
function updateFromWebcam(){if(!webcam||!useWebcam)return;const c=document.createElement('canvas');c.width=256;c.height=256;const ctx=c.getContext('2d');if(cameraFacingMode==='user'){ctx.translate(256,0);ctx.scale(-1,1);}ctx.drawImage(webcam,0,0,256,256);sourceData=new Uint8Array(ctx.getImageData(0,0,256,256).data);sourceWidth=256;sourceHeight=256;computeEdgeMap();}

function startRecording(){recordedChunks=[];const stream=canvas.captureStream(30);let mimeType='video/webm';mediaRecorder=new MediaRecorder(stream,{mimeType});mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recordedChunks.push(e.data);};mediaRecorder.onstop=()=>{const blob=new Blob(recordedChunks,{type:mimeType}),a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`vectory-${Date.now()}.webm`;a.click();showToast('Video saved!');};mediaRecorder.start();document.getElementById('recordBtn').classList.add('recording');document.getElementById('recordBtn').textContent='‚ñ† Stop';document.getElementById('mobileRecordBtn').classList.add('recording');}
function stopRecording(){if(mediaRecorder&&mediaRecorder.state!=='inactive')mediaRecorder.stop();document.getElementById('recordBtn').classList.remove('recording');document.getElementById('recordBtn').textContent='‚óè Rec';document.getElementById('mobileRecordBtn').classList.remove('recording');}
function toggleRecording(){mediaRecorder&&mediaRecorder.state==='recording'?stopRecording():startRecording();}
function saveImage(){showFlash();playSound();const a=document.createElement('a');a.download=`vectory-${Date.now()}.png`;a.href=canvas.toDataURL();a.click();showToast('Image saved!');}
function shareSettings(){const params=new URLSearchParams();for(const[k,v]of Object.entries(settings))if(v!==defaultSettings[k])params.set(k,v);const url=location.origin+location.pathname+'?'+params.toString();navigator.clipboard.writeText(url).then(()=>showToast('Link copied!'));}
function loadSettingsFromURL(){const params=new URLSearchParams(location.search);for(const[k,v]of params)if(k in settings){if(typeof settings[k]==='boolean')settings[k]=v==='true';else if(typeof settings[k]==='number')settings[k]=parseFloat(v);else settings[k]=v;}}
function toggleFullscreen(){if(document.fullscreenElement)document.exitFullscreen();else document.documentElement.requestFullscreen();}
function resetParticles(){particleCount=0;particleIdCounter=0;for(let i=0;i<MAX_PARTICLES;i++){trailCounts[i]=0;trailHeads[i]=0;}buildBrightnessSampler();}

function applyPreset(name){const p=presets[name];if(!p)return;Object.assign(settings,p);if(window.innerWidth<=900&&settings.mode>=4)settings.camDist=350;syncUI();resetParticles();currentPresetIndex=presetNames.indexOf(name);updateMobilePresetButtons();showToast(`${name} preset`);}
function updateMobilePresetButtons(){document.querySelectorAll('.mobile-presets button').forEach(btn=>{btn.classList.toggle('active',btn.dataset.preset===presetNames[currentPresetIndex]);});}

function syncUI(){document.getElementById('mode').value=settings.mode;document.getElementById('edgeMethod').value=settings.edgeMethod;document.getElementById('edgeSize').value=settings.edgeSize;document.getElementById('edgeSizeVal').textContent=settings.edgeSize+'%';document.getElementById('edgeOpacity').value=settings.edgeOpacity;document.getElementById('edgeOpacityVal').textContent=settings.edgeOpacity+'%';document.getElementById('edgeAttr').value=settings.edgeAttr;document.getElementById('edgeAttrVal').textContent=settings.edgeAttr;document.getElementById('spawn3DMode').value=settings.spawn3DMode;document.getElementById('dir3DSource').value=settings.dir3DSource;document.getElementById('imgAttr').value=settings.imgAttr;document.getElementById('imgAttrVal').textContent=settings.imgAttr;document.getElementById('channel').value=settings.channel;document.getElementById('shift').value=settings.shift;document.getElementById('shiftVal').textContent=settings.shift+'¬∞';document.getElementById('fluct').value=settings.fluct;document.getElementById('fluctVal').textContent=settings.fluct+'¬∞';document.getElementById('dynFluct').value=settings.dynFluct;document.getElementById('dynFluctVal').textContent=settings.dynFluct+'¬∞';document.getElementById('attrForce').value=settings.attrForce;document.getElementById('attrForceVal').textContent=settings.attrForce;document.getElementById('attrAngle').value=settings.attrAngle;document.getElementById('attrAngleVal').textContent=settings.attrAngle+'¬∞';document.getElementById('seed').value=settings.seed;document.getElementById('seedVal').textContent=settings.seed;document.getElementById('spawnType').value=settings.spawnType;document.getElementById('cutoff').value=settings.cutoff;document.getElementById('cutoffVal').textContent=settings.cutoff+'%';document.getElementById('count').value=settings.count;document.getElementById('countVal').textContent=settings.count;document.getElementById('lifetime').value=settings.lifetime;document.getElementById('lifetimeVal').textContent=settings.lifetime;document.getElementById('size').value=settings.size;document.getElementById('sizeVal').textContent=settings.size;document.getElementById('speed').value=settings.speed;document.getElementById('speedVal').textContent=settings.speed;document.getElementById('depthScale').value=settings.depthScale;document.getElementById('depthScaleVal').textContent=settings.depthScale;document.getElementById('camDist').value=settings.camDist;document.getElementById('camDistVal').textContent=settings.camDist;document.getElementById('fov').value=settings.fov;document.getElementById('fovVal').textContent=settings.fov+'¬∞';document.getElementById('colorMode').value=settings.colorMode;document.getElementById('customColor').value=settings.customColor;document.getElementById('startColor').value=settings.startColor;document.getElementById('endColor').value=settings.endColor;document.getElementById('glowEnabled').checked=settings.glowEnabled;document.getElementById('glowIntensity').value=settings.glowIntensity;document.getElementById('glowIntensityVal').textContent=settings.glowIntensity.toFixed(1);document.getElementById('glowRadius').value=settings.glowRadius;document.getElementById('glowRadiusVal').textContent=settings.glowRadius;document.getElementById('transparentBg').checked=settings.transparentBg;document.getElementById('bgColor').value=settings.bgColor;document.getElementById('fade').value=settings.fade;document.getElementById('fadeVal').textContent=settings.fade;document.getElementById('section3D').style.display=settings.mode>=4?'block':'none';document.getElementById('qSpeed').value=settings.speed;document.getElementById('qSpeedVal').textContent=settings.speed;document.getElementById('qSize').value=settings.size;document.getElementById('qSizeVal').textContent=settings.size;document.getElementById('qCount').value=settings.count;document.getElementById('qCountVal').textContent=settings.count;document.getElementById('rotateHint').classList.toggle('hidden',settings.mode<4||hintInteracted);}

function setupMouseControls(){
  canvas.addEventListener('mousedown',e=>{if(settings.mode>=4){isDragging=true;lastMouseX=e.clientX;lastMouseY=e.clientY;hintInteracted=true;document.getElementById('rotateHint').classList.add('hidden');}});
  document.addEventListener('mouseup',()=>isDragging=false);
  document.addEventListener('mousemove',e=>{if(isDragging&&settings.mode>=4){camRotY+=(e.clientX-lastMouseX)*0.01;camRotX+=(e.clientY-lastMouseY)*0.01;camRotX=Math.max(-Math.PI/2,Math.min(Math.PI/2,camRotX));lastMouseX=e.clientX;lastMouseY=e.clientY;}});
  
  canvas.addEventListener('touchstart',e=>{if(e.touches.length===1){swipeStartX=e.touches[0].clientX;swipeStartY=e.touches[0].clientY;isSwiping=true;if(settings.mode>=4){isDragging=true;lastMouseX=e.touches[0].clientX;lastMouseY=e.touches[0].clientY;hintInteracted=true;}}else if(e.touches.length===2&&settings.mode>=4){e.preventDefault();isDragging=false;isSwiping=false;lastPinchDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);}},{passive:false});
  
  canvas.addEventListener('touchmove',e=>{if(e.touches.length===1){const dx=e.touches[0].clientX-swipeStartX,dy=e.touches[0].clientY-swipeStartY;if(window.innerWidth<=900&&isSwiping&&Math.abs(dx)>30&&Math.abs(dx)>Math.abs(dy)){if(dx>0&&currentPresetIndex>0)document.getElementById('swipeLeft').classList.add('visible');else document.getElementById('swipeLeft').classList.remove('visible');if(dx<0&&currentPresetIndex<presetNames.length-1)document.getElementById('swipeRight').classList.add('visible');else document.getElementById('swipeRight').classList.remove('visible');}if(settings.mode>=4&&isDragging&&Math.abs(dy)>Math.abs(dx)){camRotY+=(e.touches[0].clientX-lastMouseX)*0.01;camRotX+=(e.touches[0].clientY-lastMouseY)*0.01;camRotX=Math.max(-Math.PI/2,Math.min(Math.PI/2,camRotX));lastMouseX=e.touches[0].clientX;lastMouseY=e.touches[0].clientY;isSwiping=false;}}else if(e.touches.length===2&&settings.mode>=4){e.preventDefault();const pd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);if(lastPinchDist>0){settings.camDist=Math.max(100,Math.min(1000,settings.camDist*(lastPinchDist/pd)));document.getElementById('camDist').value=Math.round(settings.camDist);document.getElementById('camDistVal').textContent=Math.round(settings.camDist);}lastPinchDist=pd;}},{passive:false});
  
  canvas.addEventListener('touchend',e=>{document.getElementById('swipeLeft').classList.remove('visible');document.getElementById('swipeRight').classList.remove('visible');const dx=e.changedTouches[0].clientX-swipeStartX,dy=e.changedTouches[0].clientY-swipeStartY;if(isSwiping&&window.innerWidth<=900){if(Math.abs(dx)>60&&Math.abs(dx)>Math.abs(dy)*1.5){if(dx>0&&currentPresetIndex>0)applyPreset(presetNames[currentPresetIndex-1]);else if(dx<0&&currentPresetIndex<presetNames.length-1)applyPreset(presetNames[currentPresetIndex+1]);}}if(window.innerWidth<=900&&Math.abs(dx)<15&&Math.abs(dy)<15){document.getElementById('quickSettings').classList.remove('visible');}isDragging=false;isSwiping=false;if(e.touches.length<2)lastPinchDist=0;});
  
  canvas.addEventListener('wheel',e=>{if(settings.mode>=4){e.preventDefault();hintInteracted=true;settings.camDist=Math.max(100,Math.min(1000,settings.camDist*(e.deltaY>0?1.1:0.9)));document.getElementById('camDist').value=Math.round(settings.camDist);document.getElementById('camDistVal').textContent=Math.round(settings.camDist);}},{passive:false});
}

document.addEventListener('keydown',e=>{if(e.key==='f'||e.key==='F')toggleFullscreen();if(e.key==='s'&&(e.metaKey||e.ctrlKey)){e.preventDefault();saveImage();}});

function setupMobileUI(){
  document.querySelectorAll('.mobile-presets button').forEach(btn=>btn.addEventListener('click',()=>applyPreset(btn.dataset.preset)));
  document.getElementById('mobileSettingsBtn').addEventListener('click',()=>document.getElementById('quickSettings').classList.toggle('visible'));
  document.getElementById('mobileWebcamBtn').addEventListener('click',()=>{if(useWebcam){stopWebcam();create3DFlowMap();}else startWebcam();});
  document.getElementById('mobileFlipCamBtn').addEventListener('click',flipCamera);
  document.getElementById('mobileSaveBtn').addEventListener('click',saveImage);
  document.getElementById('mobileRecordBtn').addEventListener('click',toggleRecording);
  document.getElementById('closeQuickSettings').addEventListener('click',()=>document.getElementById('quickSettings').classList.remove('visible'));
  
  document.getElementById('qSpeed').addEventListener('input',e=>{settings.speed=+e.target.value;document.getElementById('qSpeedVal').textContent=settings.speed;document.getElementById('speed').value=settings.speed;document.getElementById('speedVal').textContent=settings.speed;});
  document.getElementById('qSize').addEventListener('input',e=>{settings.size=+e.target.value;document.getElementById('qSizeVal').textContent=settings.size;document.getElementById('size').value=settings.size;document.getElementById('sizeVal').textContent=settings.size;});
  document.getElementById('qCount').addEventListener('input',e=>{settings.count=+e.target.value;document.getElementById('qCountVal').textContent=settings.count;document.getElementById('count').value=settings.count;document.getElementById('countVal').textContent=settings.count;});
  
  let statTimeout;
  canvas.addEventListener('click',()=>{const stats=document.getElementById('mobileStats');stats.classList.add('visible');clearTimeout(statTimeout);statTimeout=setTimeout(()=>stats.classList.remove('visible'),2000);});
}

function setupControls(){
  const upd=(id,suf='')=>{const e=document.getElementById(id),v=document.getElementById(id+'Val');if(v)v.textContent=e.value+suf;};
  document.querySelectorAll('[data-preset]').forEach(btn=>btn.addEventListener('click',()=>applyPreset(btn.dataset.preset)));
  document.getElementById('presetNoise').addEventListener('click',()=>{stopWebcam();createNoiseMap();resetParticles();});
  document.getElementById('presetGradient').addEventListener('click',()=>{stopWebcam();createGradientMap();resetParticles();});
  document.getElementById('presetRadial').addEventListener('click',()=>{stopWebcam();createRadialMap();resetParticles();});
  document.getElementById('preset3DFlow').addEventListener('click',()=>{stopWebcam();create3DFlowMap();resetParticles();});
  document.getElementById('webcamBtn').addEventListener('click',()=>{if(useWebcam){stopWebcam();create3DFlowMap();}else startWebcam();});
  document.getElementById('mode').addEventListener('change',e=>{settings.mode=+e.target.value;document.getElementById('section3D').style.display=settings.mode>=4?'block':'none';if(window.innerWidth<=900&&settings.mode>=4&&settings.camDist>500){settings.camDist=350;document.getElementById('camDist').value=350;document.getElementById('camDistVal').textContent=350;}resetParticles();});
  document.getElementById('edgeMethod').addEventListener('change',e=>{settings.edgeMethod=+e.target.value;computeEdgeMap();});
  document.getElementById('edgeSize').addEventListener('input',e=>{settings.edgeSize=+e.target.value;upd('edgeSize','%');});
  document.getElementById('edgeOpacity').addEventListener('input',e=>{settings.edgeOpacity=+e.target.value;upd('edgeOpacity','%');});
  document.getElementById('edgeAttr').addEventListener('input',e=>{settings.edgeAttr=+e.target.value;upd('edgeAttr');});
  document.getElementById('spawn3DMode').addEventListener('change',e=>settings.spawn3DMode=+e.target.value);
  document.getElementById('dir3DSource').addEventListener('change',e=>settings.dir3DSource=+e.target.value);
  document.getElementById('imgAttr').addEventListener('input',e=>{settings.imgAttr=+e.target.value;upd('imgAttr');});
  document.getElementById('channel').addEventListener('change',e=>settings.channel=+e.target.value);
  document.getElementById('shift').addEventListener('input',e=>{settings.shift=+e.target.value;upd('shift','¬∞');});
  document.getElementById('fluct').addEventListener('input',e=>{settings.fluct=+e.target.value;upd('fluct','¬∞');});
  document.getElementById('dynFluct').addEventListener('input',e=>{settings.dynFluct=+e.target.value;upd('dynFluct','¬∞');});
  document.getElementById('attrForce').addEventListener('input',e=>{settings.attrForce=+e.target.value;upd('attrForce');});
  document.getElementById('attrAngle').addEventListener('input',e=>{settings.attrAngle=+e.target.value;upd('attrAngle','¬∞');});
  document.getElementById('seed').addEventListener('input',e=>{settings.seed=+e.target.value;upd('seed');});
  document.getElementById('spawnType').addEventListener('change',e=>{settings.spawnType=+e.target.value;buildBrightnessSampler();});
  document.getElementById('cutoff').addEventListener('input',e=>{settings.cutoff=+e.target.value;upd('cutoff','%');buildBrightnessSampler();});
  document.getElementById('transparentBg').addEventListener('change',e=>settings.transparentBg=e.target.checked);
  document.getElementById('bgColor').addEventListener('input',e=>settings.bgColor=e.target.value);
  document.getElementById('fade').addEventListener('input',e=>{settings.fade=+e.target.value;upd('fade');});
  ['depthScale','camDist'].forEach(id=>document.getElementById(id).addEventListener('input',e=>{settings[id]=+e.target.value;upd(id);}));
  document.getElementById('fov').addEventListener('input',e=>{settings.fov=+e.target.value;upd('fov','¬∞');});
  document.getElementById('lifetime').addEventListener('input',e=>{settings.lifetime=+e.target.value;upd('lifetime');});
  document.getElementById('size').addEventListener('input',e=>{settings.size=+e.target.value;upd('size');document.getElementById('qSize').value=settings.size;document.getElementById('qSizeVal').textContent=settings.size;});
  document.getElementById('speed').addEventListener('input',e=>{settings.speed=+e.target.value;upd('speed');document.getElementById('qSpeed').value=settings.speed;document.getElementById('qSpeedVal').textContent=settings.speed;});
  document.getElementById('count').addEventListener('input',e=>{settings.count=+e.target.value;upd('count');document.getElementById('qCount').value=settings.count;document.getElementById('qCountVal').textContent=settings.count;});
  document.getElementById('colorMode').addEventListener('change',e=>settings.colorMode=+e.target.value);
  document.getElementById('customColor').addEventListener('input',e=>settings.customColor=e.target.value);
  document.getElementById('startColor').addEventListener('input',e=>settings.startColor=e.target.value);
  document.getElementById('endColor').addEventListener('input',e=>settings.endColor=e.target.value);
  document.getElementById('glowEnabled').addEventListener('change',e=>{settings.glowEnabled=e.target.checked;});
  document.getElementById('glowIntensity').addEventListener('input',e=>{settings.glowIntensity=+e.target.value;document.getElementById('glowIntensityVal').textContent=(+e.target.value).toFixed(1);});
  document.getElementById('glowRadius').addEventListener('input',e=>{settings.glowRadius=+e.target.value;upd('glowRadius');});
  document.getElementById('resetBtn').addEventListener('click',resetParticles);
  document.getElementById('recordBtn').addEventListener('click',toggleRecording);
  document.getElementById('saveBtn').addEventListener('click',saveImage);
  document.getElementById('shareBtn').addEventListener('click',shareSettings);
  document.getElementById('fullscreenBtn').addEventListener('click',toggleFullscreen);
  document.getElementById('imageInput').addEventListener('change',e=>{const f=e.target.files[0];if(f){stopWebcam();const img=new Image();img.onload=()=>{const c=document.createElement('canvas');c.width=img.width;c.height=img.height;const ctx=c.getContext('2d');ctx.drawImage(img,0,0);sourceData=new Uint8Array(ctx.getImageData(0,0,img.width,img.height).data);sourceWidth=img.width;sourceHeight=img.height;computeEdgeMap();updateCanvasSize();updatePreview();resetParticles();};img.src=URL.createObjectURL(f);}});
  syncUI();
}

function updateCanvasSize(){
  const cont=document.getElementById('canvas-container'),isMobile=window.innerWidth<=900;
  if(isMobile){canvasWidth=window.innerWidth;canvasHeight=window.innerHeight;}
  else{const p=24,sh=60,mw=cont.clientWidth-p,mh=cont.clientHeight-sh,ar=sourceWidth&&sourceHeight?sourceWidth/sourceHeight:16/9;if(mw/mh>ar){canvasHeight=mh;canvasWidth=Math.round(canvasHeight*ar);}else{canvasWidth=mw;canvasHeight=Math.round(canvasWidth/ar);}canvasWidth=Math.max(200,canvasWidth);canvasHeight=Math.max(150,canvasHeight);}
  if(canvas){canvas.width=canvasWidth;canvas.height=canvasHeight;canvas.style.width=isMobile?'100%':canvasWidth+'px';canvas.style.height=isMobile?'100%':canvasHeight+'px';if(gl){gl.viewport(0,0,canvasWidth,canvasHeight);resizeGlowResources();}}
}

function init(){
  const hasUrlParams=location.search.length>1;
  if(!hasUrlParams)Object.assign(settings,presets.matrix);else loadSettingsFromURL();
  if(window.innerWidth<=900&&settings.mode>=4)settings.camDist=350;
  if(!initWebGL())return;
  create3DFlowMap();
  updateCanvasSize();
  buildBrightnessSampler();
  setupControls();
  setupMouseControls();
  setupMobileUI();
  syncUI();
  updateMobilePresetButtons();
  // Auto-start camera on mobile
  if(window.innerWidth<=900&&!hasUrlParams){setTimeout(()=>startWebcam('user'),500);}
  mainLoop();
}

window.addEventListener('load',init);
window.addEventListener('resize',updateCanvasSize);
window.addEventListener('orientationchange',()=>setTimeout(updateCanvasSize,100));
</script>
</body>
</html>
