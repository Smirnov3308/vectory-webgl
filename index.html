<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vectory - Particle System</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --background: 240 10% 3.9%;
      --foreground: 0 0% 98%;
      --card: 240 10% 3.9%;
      --primary: 0 0% 98%;
      --primary-foreground: 240 5.9% 10%;
      --secondary: 240 3.7% 15.9%;
      --secondary-foreground: 0 0% 98%;
      --muted: 240 3.7% 15.9%;
      --muted-foreground: 240 5% 64.9%;
      --border: 240 3.7% 15.9%;
      --input: 240 3.7% 15.9%;
      --ring: 240 4.9% 83.9%;
      --radius: 0.5rem;
      --success: 142 70% 45%;
      --danger: 0 72% 51%;
    }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: hsl(var(--background));
      color: hsl(var(--foreground));
      height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }
    .control-group { margin-bottom: 16px; }
    .control-group:last-child { margin-bottom: 0; }
    label { display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
    label .value { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: hsl(var(--muted-foreground)); background: hsl(var(--muted)); padding: 2px 6px; border-radius: 4px; min-width: 32px; text-align: center; display: inline-block; }
    .desktop-toolbar { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 12px; max-width: 900px; width: 100%; padding: 10px 16px; margin-top: 12px; background: hsl(var(--card) / 0.9); backdrop-filter: blur(8px); border: 1px solid hsl(var(--border)); border-radius: 12px; flex-shrink: 0; }
    .desktop-presets { display: flex; gap: 6px; }
    .desktop-presets button { height: 32px; padding: 0 14px; border-radius: 18px; font-size: 13px; font-weight: 500; background: hsl(var(--secondary)); color: hsl(var(--secondary-foreground)); }
    .desktop-presets button.active { background: hsl(var(--primary)); color: hsl(var(--primary-foreground)); }
    .desktop-actions { display: flex; gap: 6px; }
    .desktop-actions button { width: 36px; height: 36px; padding: 0; border-radius: 10px; }
    .desktop-actions button svg { width: 18px; height: 18px; }
    .desktop-actions button.active { background: hsl(var(--success)); color: white; }
    .desktop-actions button.recording { background: hsl(var(--danger)); color: white; }
    .desktop-settings-anchor { position: relative; }
    .desktop-quick-settings { position: absolute; bottom: 100%; right: 0; margin-bottom: 8px; width: 260px; padding: 16px; background: hsl(var(--card) / 0.95); backdrop-filter: blur(12px); border: 1px solid hsl(var(--border)); border-radius: 12px; z-index: 60; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; }
    .desktop-quick-settings.visible { display: block; }
    .desktop-quick-settings .control-group { margin-bottom: 14px; }
    .desktop-quick-settings .control-group:last-child { margin-bottom: 0; }
    .desktop-quick-settings label { font-size: 13px; margin-bottom: 8px; }
    input[type="range"] { width: 100%; height: 8px; -webkit-appearance: none; background: hsl(var(--secondary)); border-radius: 9999px; cursor: pointer; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: hsl(var(--primary)); border-radius: 9999px; cursor: pointer; }
    select, input[type="file"], input[type="color"] { width: 100%; height: 36px; padding: 0 12px; background: hsl(var(--background)); border: 1px solid hsl(var(--input)); border-radius: var(--radius); color: hsl(var(--foreground)); font-size: 14px; }
    .checkbox-wrapper { display: flex; align-items: center; gap: 8px; }
    .checkbox-wrapper input { width: 16px; height: 16px; }
    .checkbox-wrapper label { margin: 0; }
    button { display: inline-flex; align-items: center; justify-content: center; gap: 6px; height: 36px; padding: 0 16px; background: hsl(var(--primary)); color: hsl(var(--primary-foreground)); border: none; border-radius: var(--radius); font-size: 14px; font-weight: 500; cursor: pointer; }
    button:hover { opacity: 0.9; }
    button:active { transform: scale(0.98); }
    button.secondary { background: hsl(var(--secondary)); color: hsl(var(--secondary-foreground)); }
    button.outline { background: transparent; border: 1px solid hsl(var(--input)); color: hsl(var(--foreground)); }
    button.ghost { background: transparent; color: hsl(var(--foreground)); }
    button.recording { background: hsl(var(--danger)); animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    #canvas-container { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; width: 100%; padding: 12px; background: hsl(var(--background)); position: relative; overflow: hidden; }
    .stat { display: flex; align-items: center; gap: 8px; }
    .stat-label { color: hsl(var(--muted-foreground)); }
    .stat-value { color: hsl(var(--foreground)); font-weight: 500; }
    .stat-value.fps { color: hsl(var(--success)); }
    #canvas-wrapper { position: relative; flex: 1; min-height: 0; display: flex; align-items: center; justify-content: center; }
    canvas { border-radius: var(--radius); border: 1px solid hsl(var(--border)); touch-action: none; max-width: 100%; max-height: 100%; }
    .flash-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: white; opacity: 0; pointer-events: none; border-radius: var(--radius); }
    .flash-overlay.flash { animation: flashAnim 0.25s ease-out; }
    @keyframes flashAnim { 0% { opacity: 0.7; } 100% { opacity: 0; } }
    .rotate-hint { position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); padding: 10px 14px; background: hsl(var(--card) / 0.95); backdrop-filter: blur(8px); border: 1px solid hsl(var(--border)); border-radius: var(--radius); font-size: 13px; color: hsl(var(--muted-foreground)); pointer-events: none; transition: opacity 0.3s; }
    .rotate-hint.hidden { opacity: 0; }
    .rotate-hint kbd { display: inline-flex; align-items: center; height: 20px; padding: 0 6px; background: hsl(var(--muted)); border: 1px solid hsl(var(--border)); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 11px; margin: 0 3px; }
    .share-anchor { position: relative; }
    .share-dropdown { position: absolute; bottom: 100%; right: 0; margin-bottom: 8px; min-width: 180px; background: hsl(var(--card)); border: 1px solid hsl(var(--border)); border-radius: var(--radius); padding: 4px; z-index: 200; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .share-dropdown button { width: 100%; justify-content: flex-start; gap: 10px; height: 36px; padding: 0 12px; background: transparent; color: hsl(var(--foreground)); font-size: 13px; border-radius: 4px; }
    .share-dropdown button:hover { background: hsl(var(--muted)); }
    .share-dropdown button svg { width: 16px; height: 16px; flex-shrink: 0; }
    .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px); display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: hsl(var(--card)); border: 1px solid hsl(var(--border)); border-radius: var(--radius); font-size: 14px; opacity: 0; transition: transform 0.3s, opacity 0.3s; z-index: 1000; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast-icon { width: 20px; height: 20px; background: hsl(var(--success)); border-radius: 9999px; display: flex; align-items: center; justify-content: center; }
    .toast-icon svg { width: 12px; height: 12px; color: white; }
    @media (max-width: 900px) {
      body { flex-direction: column; }
      #canvas-container { flex: 1; padding: 0; }
      .mobile-stats { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); display: flex; gap: 16px; padding: 8px 14px; background: hsl(var(--card) / 0.9); backdrop-filter: blur(8px); border: 1px solid hsl(var(--border)); border-radius: var(--radius); font-size: 12px; font-family: 'JetBrains Mono', monospace; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 20; }
      .mobile-stats.visible { opacity: 1; }
      .mobile-stats .stat-value.fps { color: hsl(var(--success)); }
      #canvas-wrapper { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
      canvas { max-width: 100%; max-height: 100%; width: 100% !important; height: 100% !important; border: none; border-radius: 0; }
      .mobile-presets { position: fixed; bottom: 70px; left: 0; right: 0; display: flex; justify-content: center; padding: 10px 16px; z-index: 50; pointer-events: none; }
      .swipe-hint { padding: 8px 16px; background: hsl(var(--card) / 0.7); backdrop-filter: blur(8px); border: 1px solid hsl(var(--border)); border-radius: 18px; font-size: 12px; color: hsl(var(--muted-foreground)); opacity: 1; transition: opacity 1s; }
      .swipe-hint.hidden { opacity: 0; }
      .mobile-toolbar { position: fixed; bottom: 0; left: 0; right: 0; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px 16px; padding-bottom: max(12px, env(safe-area-inset-bottom)); background: hsl(var(--card) / 0.95); backdrop-filter: blur(12px); border-top: 1px solid hsl(var(--border)); z-index: 100; }
      .mobile-toolbar button { width: 44px; height: 44px; padding: 0; border-radius: 12px; background: hsl(var(--secondary)); }
      .mobile-toolbar button svg { width: 20px; height: 20px; }
      .mobile-toolbar button.active { background: hsl(var(--success)); color: white; }
      .mobile-toolbar button.recording { background: hsl(var(--danger)); color: white; }
      .mobile-toolbar .desktop-hint { font-size: 10px; color: hsl(var(--muted-foreground)); margin-left: 8px; }
      .quick-settings { position: fixed; bottom: 130px; left: 16px; right: 16px; max-width: 320px; margin: 0 auto; padding: 16px; background: hsl(var(--card) / 0.95); backdrop-filter: blur(12px); border: 1px solid hsl(var(--border)); border-radius: 16px; z-index: 60; transform: translateY(20px); opacity: 0; pointer-events: none; transition: transform 0.25s, opacity 0.25s; }
      .quick-settings.visible { transform: translateY(0); opacity: 1; pointer-events: auto; }
      .quick-settings-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
      .quick-settings-header h3 { font-size: 14px; font-weight: 600; }
      .quick-settings-header button { width: 28px; height: 28px; padding: 0; background: transparent; }
      .quick-settings .control-group { margin-bottom: 14px; }
      .quick-settings label { font-size: 13px; margin-bottom: 8px; }
      .quick-settings input[type="range"]::-webkit-slider-thumb { width: 20px; height: 20px; }
      .swipe-indicator { position: absolute; top: 50%; transform: translateY(-50%); padding: 12px 16px; background: hsl(var(--card) / 0.9); backdrop-filter: blur(8px); border: 1px solid hsl(var(--border)); border-radius: var(--radius); font-size: 14px; font-weight: 500; opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 30; }
      .swipe-indicator.left { left: 20px; }
      .swipe-indicator.right { right: 20px; }
      .swipe-indicator.visible { opacity: 1; }
      .rotate-hint { display: none; }
      .toast { bottom: 140px; }
    }
    @media (min-width: 901px) {
      .mobile-presets, .mobile-toolbar, .mobile-stats, .quick-settings, .swipe-indicator { display: none !important; }
      .rotate-hint .hint-mobile { display: none; }
      .desktop-toolbar { display: flex; }
    }
    @media (max-width: 900px) {
      .desktop-toolbar { display: none !important; }
    }
  </style>
</head>
<body>
  <div id="canvas-container">
    <div class="mobile-stats" id="mobileStats"><span><span class="stat-value fps" id="mobileFps">--</span> FPS</span><span><span id="mobileParticleCount">0</span> particles</span></div>
    <div id="canvas-wrapper"><canvas id="glCanvas"></canvas><div class="flash-overlay" id="flashOverlay"></div><div class="rotate-hint" id="rotateHint"><span class="hint-desktop">Drag to rotate · <kbd>Scroll</kbd> zoom · <kbd>F</kbd> fullscreen</span></div></div>
    <div class="swipe-indicator left" id="swipeLeft">← Previous</div><div class="swipe-indicator right" id="swipeRight">Next →</div>
    <div class="desktop-toolbar" id="desktopToolbar">
      <div class="desktop-presets"><button data-preset="matrix" class="active">Matrix</button><button data-preset="particles">Particles</button><button data-preset="rain">Trails</button></div>
      <div class="desktop-actions"><div class="desktop-settings-anchor"><button class="secondary" id="desktopSettingsBtn" title="Settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></button><div class="desktop-quick-settings" id="desktopQuickSettings"><div class="control-group"><label>Speed <span class="value" id="speedVal">2</span></label><input type="range" id="speed" min="0.5" max="20" value="2" step="0.5"></div><div class="control-group"><label>Size <span class="value" id="sizeVal">3</span></label><input type="range" id="size" min="1" max="30" value="3"></div><div class="control-group"><label>Count <span class="value" id="countVal">1000</span></label><input type="range" id="count" min="1" max="2000" value="1000"></div></div></div><button class="secondary" id="webcamBtn" title="Camera"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg></button><button class="secondary" id="recordBtn" title="Record"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4" fill="currentColor"/></svg></button><button class="secondary" id="saveBtn" title="Save"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg></button><div class="share-anchor"><button class="secondary" id="shareBtn" title="Share"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg></button><div class="share-dropdown" id="shareDropdown" style="display:none"><button id="shareTelegram"><svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg> Telegram</button><button id="shareTwitter"><svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg> X (Twitter)</button></div></div><button class="secondary" id="fullscreenBtn" title="Fullscreen"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg></button></div>
    </div>
  </div>
  <div class="mobile-presets" id="mobilePresets"><div class="swipe-hint" id="mobileSwipeHint">← swipe to change →</div></div>
  <div class="mobile-toolbar" id="mobileToolbar">
    <button id="mobileSettingsBtn" title="Settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></button>
    <button id="mobileWebcamBtn" title="Camera"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg></button>
    <button id="mobileFlipCamBtn" title="Flip Camera" style="display:none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5"/><path d="M13 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-5"/><circle cx="12" cy="12" r="3"/><path d="m18 22-3-3 3-3"/><path d="m6 2 3 3-3 3"/></svg></button>
    <button id="mobileRecordBtn" title="Record"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4" fill="currentColor"/></svg></button>
    <button id="mobileSaveBtn" title="Save"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg></button>
    <button id="mobileShareBtn" title="Share"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg></button>
  </div>
  <div class="quick-settings" id="quickSettings"><div class="quick-settings-header"><h3>Quick Settings</h3><button id="closeQuickSettings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button></div><div class="control-group"><label>Speed <span class="value" id="qSpeedVal">2</span></label><input type="range" id="qSpeed" min="0.5" max="20" value="2" step="0.5"></div><div class="control-group"><label>Size <span class="value" id="qSizeVal">3</span></label><input type="range" id="qSize" min="1" max="30" value="3"></div><div class="control-group"><label>Count <span class="value" id="qCountVal">1000</span></label><input type="range" id="qCount" min="10" max="2000" value="1000"></div></div>
  <div class="toast" id="toast"><div class="toast-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div><span id="toastMessage">Saved!</span></div>
<script>
(function() {
'use strict';
// === Named constants (was magic numbers) ===
const TAU = Math.PI * 2;
const DEG_TO_RAD = Math.PI / 180;
const FLUCT_SCALE = 0.708;
const NOISE_MAGIC = 43758.5453;
const MAX_PARTICLES = 200000;
const TRAIL_LENGTH = 20;
const STATIC_MAX = 500000;
const TRIG_SIZE = 720;
const WEBCAM_SIZE = 256;
const FPS_INTERVAL = 500;
// === Sin/cos LUT ===
const sinLUT = new Float32Array(TRIG_SIZE), cosLUT = new Float32Array(TRIG_SIZE);
for(let i=0;i<TRIG_SIZE;i++){const a=i*TAU/TRIG_SIZE;sinLUT[i]=Math.sin(a);cosLUT[i]=Math.cos(a);}
const fastSin=a=>{const i=((a%TAU+TAU)%TAU)/TAU*TRIG_SIZE|0;return sinLUT[i%TRIG_SIZE];};
const fastCos=a=>{const i=((a%TAU+TAU)%TAU)/TAU*TRIG_SIZE|0;return cosLUT[i%TRIG_SIZE];};
// === FIX: Shared AudioContext ===
let sharedAudioCtx=null;
function getAudioCtx(){if(!sharedAudioCtx||sharedAudioCtx.state==='closed')sharedAudioCtx=new(window.AudioContext||window.webkitAudioContext)();if(sharedAudioCtx.state==='suspended')sharedAudioCtx.resume();return sharedAudioCtx;}
// === FIX: Reusable offscreen canvases ===
let wcOffscreen=null,wcCtx=null;
function getWcCanvas(w,h){if(!wcOffscreen||wcOffscreen.width!==w){wcOffscreen=document.createElement('canvas');wcOffscreen.width=w;wcOffscreen.height=h;wcCtx=wcOffscreen.getContext('2d',{willReadFrequently:true});}return wcCtx;}
let pvOffscreen=null,pvCtx=null;
function getPvCanvas(w,h){if(!pvOffscreen||pvOffscreen.width!==w||pvOffscreen.height!==h){pvOffscreen=document.createElement('canvas');pvOffscreen.width=w;pvOffscreen.height=h;pvCtx=pvOffscreen.getContext('2d');}return{c:pvOffscreen,ctx:pvCtx};}
// === FIX: Track object URLs ===
let lastObjURL=null;
function revokeObjURL(){if(lastObjURL){URL.revokeObjectURL(lastObjURL);lastObjURL=null;}}

const defaultSettings={mode:4,seed:1,spawnType:1,count:1000,cutoff:30,edgeMethod:1,edgeSize:0,edgeOpacity:0,edgeAttr:0,lifetime:100,size:3,speed:2,channel:1,shift:0,fluct:0,dynFluct:0,attrForce:0,attrAngle:0,colorMode:1,customColor:'#ffffff',startColor:'#ffffff',endColor:'#e94560',transparentBg:false,bgColor:'#000000',fade:3,camDist:850,fov:60,depthScale:100,spawn3DMode:2,dir3DSource:2,imgAttr:0,glowEnabled:false,glowIntensity:1,glowRadius:20,glowThreshold:0};
let settings={...defaultSettings};
const presetNames=['matrix','particles','rain'];
let currentPresetIndex=0;
const presets={
  matrix:{mode:2,count:800,size:2,speed:4,lifetime:100,colorMode:4,startColor:'#22c55e',endColor:'#052e16',attrForce:3,attrAngle:270,fluct:122,dynFluct:67,edgeMethod:2,edgeSize:28,edgeOpacity:100,edgeAttr:6,glowEnabled:true,glowIntensity:3,glowRadius:5},
  particles:{mode:1,count:500,size:3,speed:5,lifetime:100,colorMode:1,attrForce:2,attrAngle:270,fluct:30,dynFluct:40,edgeMethod:1,edgeSize:0,edgeOpacity:0,edgeAttr:0,glowEnabled:false},
  rain:{mode:3,count:300,size:2,speed:6,lifetime:40,colorMode:1,attrForce:6,attrAngle:270,fade:8,edgeMethod:2,edgeSize:50,edgeOpacity:80,edgeAttr:0,glowEnabled:false}
};

let gl,canvas,program,lineProgram,positionBuffer,colorBuffer,sizeBuffer,uProjection,uView,uResolution,uIs3D;
let glowProgram,compositeProgram,quadBuffer,framebufferA,framebufferB,framebufferMain,textureA,textureB,textureMain;
let glowLocs={},compositeLocs={},lineLocs={},mainLocs={};
let particleCount=0,dpr=1;
const positions=new Float32Array(MAX_PARTICLES*3),colors=new Float32Array(MAX_PARTICLES*4),sizes=new Float32Array(MAX_PARTICLES),velocities=new Float32Array(MAX_PARTICLES*3),lifetimes=new Float32Array(MAX_PARTICLES),maxLifetimes=new Float32Array(MAX_PARTICLES),origPositions=new Float32Array(MAX_PARTICLES*3),particleFluct=new Float32Array(MAX_PARTICLES),particleIds=new Uint32Array(MAX_PARTICLES),particleSpeeds=new Float32Array(MAX_PARTICLES);
let particleIdCounter=0;
const trailPositions=new Float32Array(MAX_PARTICLES*TRAIL_LENGTH*3),trailColors=new Float32Array(MAX_PARTICLES*TRAIL_LENGTH*4),trailSizes=new Float32Array(MAX_PARTICLES*TRAIL_LENGTH),trailCounts=new Uint16Array(MAX_PARTICLES),trailHeads=new Uint16Array(MAX_PARTICLES);
const trailTriPos=new Float32Array(MAX_PARTICLES*TRAIL_LENGTH*6*3),trailTriCol=new Float32Array(MAX_PARTICLES*TRAIL_LENGTH*6*4);
const staticPos=new Float32Array(STATIC_MAX*3),staticCol=new Float32Array(STATIC_MAX*4),staticSiz=new Float32Array(STATIC_MAX);

let sourceData=null,sourceWidth=0,sourceHeight=0,canvasWidth=1280,canvasHeight=720;
let camRotX=0.3,camRotY=0,isDragging=false,lastMouseX=0,lastMouseY=0,lastPinchDist=0;
let webcam=null,useWebcam=false,frameCount=0,lastTime=performance.now(),fps=0,hintInteracted=false;
let brightnessSamples=[],brightnessSamplerReady=false,mediaRecorder=null,recordedChunks=[];
let cameraFacingMode='user',swipeStartX=0,swipeStartY=0,isSwiping=false;
let edgeData=null,edgeFieldData=null,prevEdgeData=null,edgeFrameCount=0,cachedColors={};
let isFlippingCamera=false;

function hash2(a,b){let x=(a*374761393+b*668265263)|0;x=((x>>>16)^x)*0x45d9f3b|0;x=((x>>>16)^x)*0x45d9f3b|0;return(x>>>16)^x;}
const hashFloat2=(a,b)=>(hash2(a,b)>>>0)/4294967296;
const hashRange=(a,b,min,max)=>min+hashFloat2(a,b)*(max-min);
// FIX: unsigned modulo for correct -128..+128 range
function hashFluct(a,b){return((hash2(a,b)>>>0)%257)-128;}
function hexToRgb(h){const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:{r:255,g:255,b:255};}

function showToast(m){const t=document.getElementById('toast');document.getElementById('toastMessage').textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);}
function showFlash(){const f=document.getElementById('flashOverlay');f.classList.remove('flash');void f.offsetWidth;f.classList.add('flash');}
function playSound(){try{const c=getAudioCtx(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=1800;o.type='square';g.gain.setValueAtTime(0.2,c.currentTime);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+0.04);o.start();o.stop(c.currentTime+0.04);}catch(e){}}

function perspectiveMatrix(fov,a,n,f){const t=1/Math.tan(fov*DEG_TO_RAD*0.5),nf=1/(n-f);return new Float32Array([t/a,0,0,0,0,t,0,0,0,0,(f+n)*nf,-1,0,0,2*f*n*nf,0]);}
function orthoMatrix(l,r,b,t,n,f){return new Float32Array([2/(r-l),0,0,0,0,2/(t-b),0,0,0,0,-2/(f-n),0,-(r+l)/(r-l),-(t+b)/(t-b),-(f+n)/(f-n),1]);}
function viewMatrix(rx,ry,d){const cx=Math.cos(rx),sx=Math.sin(rx),cy=Math.cos(ry),sy=Math.sin(ry);return new Float32Array([cy,sx*sy,-cx*sy,0,0,cx,sx,0,sy,-sx*cy,cx*cy,0,0,0,-d,1]);}
const identityMatrix=()=>new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);

const vsSource=`attribute vec3 aPosition;attribute vec4 aColor;attribute float aSize;uniform mat4 uProjection,uView;uniform vec2 uResolution;uniform float uIs3D;varying vec4 vColor;void main(){vec4 vp=uView*vec4(aPosition,1.0);gl_Position=uProjection*vp;gl_PointSize=uIs3D>0.5?clamp(aSize*(uResolution.y/length(vp.xyz))*0.5,1.0,100.0):aSize;vColor=aColor;}`;
const fsSource=`precision mediump float;varying vec4 vColor;void main(){vec2 c=gl_PointCoord-0.5;float d=length(c);if(d>0.5)discard;gl_FragColor=vec4(vColor.rgb,smoothstep(0.5,0.2,d)*vColor.a);}`;
const lineVsSource=`attribute vec3 aPosition;attribute vec4 aColor;uniform mat4 uProjection,uView;varying vec4 vColor;void main(){gl_Position=uProjection*uView*vec4(aPosition,1.0);vColor=aColor;}`;
const lineFsSource=`precision mediump float;varying vec4 vColor;void main(){gl_FragColor=vColor;}`;
const blurVsSource=`attribute vec2 aPosition;varying vec2 vUv;void main(){vUv=aPosition*0.5+0.5;gl_Position=vec4(aPosition,0.0,1.0);}`;
const blurFsSource=`precision mediump float;uniform sampler2D uTexture;uniform vec2 uDirection,uResolution;varying vec2 vUv;void main(){vec4 c=vec4(0.0);vec2 off=uDirection/uResolution;c+=texture2D(uTexture,vUv-off*3.0)*0.06;c+=texture2D(uTexture,vUv-off*2.0)*0.12;c+=texture2D(uTexture,vUv-off)*0.18;c+=texture2D(uTexture,vUv)*0.28;c+=texture2D(uTexture,vUv+off)*0.18;c+=texture2D(uTexture,vUv+off*2.0)*0.12;c+=texture2D(uTexture,vUv+off*3.0)*0.06;gl_FragColor=c;}`;
const compositeVsSource=`attribute vec2 aPosition;varying vec2 vUv;void main(){vUv=aPosition*0.5+0.5;gl_Position=vec4(aPosition,0.0,1.0);}`;
const compositeFsSource=`precision mediump float;uniform sampler2D uOriginal,uGlow;uniform float uIntensity;varying vec2 vUv;void main(){gl_FragColor=texture2D(uOriginal,vUv)+texture2D(uGlow,vUv)*uIntensity;}`;

// FIX: Shader/program error checking
function createShader(gl,type,src){const s=gl.createShader(type);gl.shaderSource(s,src);gl.compileShader(s);if(!gl.getShaderParameter(s,gl.COMPILE_STATUS)){console.error('Shader error:',gl.getShaderInfoLog(s));gl.deleteShader(s);return null;}return s;}
function createProgram(gl,vs,fs){if(!vs||!fs)return null;const p=gl.createProgram();gl.attachShader(p,vs);gl.attachShader(p,fs);gl.linkProgram(p);if(!gl.getProgramParameter(p,gl.LINK_STATUS)){console.error('Link error:',gl.getProgramInfoLog(p));gl.deleteProgram(p);return null;}return p;}
function createFramebuffer(gl,w,h){const fb=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,fb);const tex=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,tex);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,w,h,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,tex,0);gl.bindFramebuffer(gl.FRAMEBUFFER,null);return{framebuffer:fb,texture:tex};}
function initGlowResources(){const w=canvasWidth,h=canvasHeight;const m=createFramebuffer(gl,w,h);framebufferMain=m.framebuffer;textureMain=m.texture;const a=createFramebuffer(gl,w/2,h/2);framebufferA=a.framebuffer;textureA=a.texture;const b=createFramebuffer(gl,w/2,h/2);framebufferB=b.framebuffer;textureB=b.texture;quadBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,quadBuffer);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),gl.STATIC_DRAW);glowProgram=createProgram(gl,createShader(gl,gl.VERTEX_SHADER,blurVsSource),createShader(gl,gl.FRAGMENT_SHADER,blurFsSource));compositeProgram=createProgram(gl,createShader(gl,gl.VERTEX_SHADER,compositeVsSource),createShader(gl,gl.FRAGMENT_SHADER,compositeFsSource));if(glowProgram){glowLocs={uTex:gl.getUniformLocation(glowProgram,'uTexture'),uDir:gl.getUniformLocation(glowProgram,'uDirection'),uRes:gl.getUniformLocation(glowProgram,'uResolution'),aPos:gl.getAttribLocation(glowProgram,'aPosition')};}if(compositeProgram){compositeLocs={uOrig:gl.getUniformLocation(compositeProgram,'uOriginal'),uGlow:gl.getUniformLocation(compositeProgram,'uGlow'),uInt:gl.getUniformLocation(compositeProgram,'uIntensity'),aPos:gl.getAttribLocation(compositeProgram,'aPosition')};}}
function resizeGlowResources(){if(!gl)return;const w=canvasWidth,h=canvasHeight;gl.bindTexture(gl.TEXTURE_2D,textureMain);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,w,h,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindTexture(gl.TEXTURE_2D,textureA);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,w/2,h/2,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindTexture(gl.TEXTURE_2D,textureB);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,w/2,h/2,0,gl.RGBA,gl.UNSIGNED_BYTE,null);}

function initWebGL(){canvas=document.getElementById('glCanvas');dpr=Math.min(window.devicePixelRatio||1,2);canvas.width=canvasWidth;canvas.height=canvasHeight;gl=canvas.getContext('webgl',{alpha:true,antialias:true,preserveDrawingBuffer:true});if(!gl){console.error('WebGL not supported');return false;}program=createProgram(gl,createShader(gl,gl.VERTEX_SHADER,vsSource),createShader(gl,gl.FRAGMENT_SHADER,fsSource));lineProgram=createProgram(gl,createShader(gl,gl.VERTEX_SHADER,lineVsSource),createShader(gl,gl.FRAGMENT_SHADER,lineFsSource));if(!program||!lineProgram){console.error('Shader creation failed');return false;}positionBuffer=gl.createBuffer();colorBuffer=gl.createBuffer();sizeBuffer=gl.createBuffer();
// FIX: Pre-allocate GPU buffers
gl.bindBuffer(gl.ARRAY_BUFFER,positionBuffer);gl.bufferData(gl.ARRAY_BUFFER,MAX_PARTICLES*3*4,gl.DYNAMIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,colorBuffer);gl.bufferData(gl.ARRAY_BUFFER,MAX_PARTICLES*4*4,gl.DYNAMIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,sizeBuffer);gl.bufferData(gl.ARRAY_BUFFER,MAX_PARTICLES*4,gl.DYNAMIC_DRAW);
gl.enable(gl.BLEND);gl.useProgram(program);uProjection=gl.getUniformLocation(program,'uProjection');uView=gl.getUniformLocation(program,'uView');uResolution=gl.getUniformLocation(program,'uResolution');uIs3D=gl.getUniformLocation(program,'uIs3D');mainLocs={aPos:gl.getAttribLocation(program,'aPosition'),aCol:gl.getAttribLocation(program,'aColor'),aSiz:gl.getAttribLocation(program,'aSize')};lineLocs={uProj:gl.getUniformLocation(lineProgram,'uProjection'),uView:gl.getUniformLocation(lineProgram,'uView'),aPos:gl.getAttribLocation(lineProgram,'aPosition'),aCol:gl.getAttribLocation(lineProgram,'aColor')};initGlowResources();return true;}

// FIX: Reusable pixel object to reduce GC
const _px={r:128,g:128,b:128};
function getSourcePixel(x,y){if(!sourceData){_px.r=128;_px.g=128;_px.b=128;return _px;}const sx=Math.floor((x/canvasWidth)*sourceWidth),sy=Math.floor(((canvasHeight-y)/canvasHeight)*sourceHeight),idx=(Math.max(0,Math.min(sourceHeight-1,sy))*sourceWidth+Math.max(0,Math.min(sourceWidth-1,sx)))*4;_px.r=sourceData[idx];_px.g=sourceData[idx+1];_px.b=sourceData[idx+2];return _px;}
function getBrightness(x,y){const p=getSourcePixel(x,y);return 0.2126*p.r+0.7152*p.g+0.0722*p.b;}
function buildBrightnessSampler(){if(!sourceData)return;brightnessSamples=[];const step=Math.max(1,Math.floor(Math.min(sourceWidth,sourceHeight)/128)),thresh=settings.cutoff*2.55;for(let y=0;y<sourceHeight;y+=step)for(let x=0;x<sourceWidth;x+=step){const idx=(y*sourceWidth+x)*4,br=0.2126*sourceData[idx]+0.7152*sourceData[idx+1]+0.0722*sourceData[idx+2];if(br>=thresh)brightnessSamples.push({x:(x/sourceWidth)*canvasWidth,y:(y/sourceHeight)*canvasHeight});}brightnessSamplerReady=brightnessSamples.length>0;}

function computeEdgeMap(){if(!sourceData)return;const w=sourceWidth,h=sourceHeight,method=settings.edgeMethod||1;const gray=new Float32Array(w*h);for(let i=0;i<w*h;i++){const idx=i*4;gray[i]=0.2126*sourceData[idx]+0.7152*sourceData[idx+1]+0.0722*sourceData[idx+2];}
function gaussianBlur(src,r){if(r<1)return src;const dst=new Float32Array(w*h),kernel=[];let sum=0;for(let i=-r;i<=r;i++){const v=Math.exp(-(i*i)/(2*(r/2)*(r/2)));kernel.push(v);sum+=v;}for(let i=0;i<kernel.length;i++)kernel[i]/=sum;const tmp=new Float32Array(w*h);for(let y=0;y<h;y++)for(let x=0;x<w;x++){let v=0;for(let k=-r;k<=r;k++){const xx=Math.max(0,Math.min(w-1,x+k));v+=src[y*w+xx]*kernel[k+r];}tmp[y*w+x]=v;}for(let y=0;y<h;y++)for(let x=0;x<w;x++){let v=0;for(let k=-r;k<=r;k++){const yy=Math.max(0,Math.min(h-1,y+k));v+=tmp[yy*w+x]*kernel[k+r];}dst[y*w+x]=v;}return dst;}
function sobel(src){const mag=new Float32Array(w*h);let mx=0;for(let y=1;y<h-1;y++)for(let x=1;x<w-1;x++){const idx=y*w+x,gx=-src[(y-1)*w+(x-1)]-2*src[y*w+(x-1)]-src[(y+1)*w+(x-1)]+src[(y-1)*w+(x+1)]+2*src[y*w+(x+1)]+src[(y+1)*w+(x+1)],gy=-src[(y-1)*w+(x-1)]-2*src[(y-1)*w+x]-src[(y-1)*w+(x+1)]+src[(y+1)*w+(x-1)]+2*src[(y+1)*w+x]+src[(y+1)*w+(x+1)],m=Math.sqrt(gx*gx+gy*gy);mag[idx]=m;if(m>mx)mx=m;}if(mx>0)for(let i=0;i<w*h;i++)mag[i]/=mx;return mag;}
edgeData=new Float32Array(w*h);if(method===1){edgeData=sobel(gaussianBlur(gray,1));}else{const blurred=gaussianBlur(gray,2),mag=sobel(blurred);for(let i=0;i<w*h;i++)edgeData[i]=mag[i]>0.1?mag[i]:mag[i]*0.3;}if(prevEdgeData&&prevEdgeData.length===edgeData.length){for(let i=0;i<edgeData.length;i++)edgeData[i]=edgeData[i]*0.3+prevEdgeData[i]*0.7;}prevEdgeData=new Float32Array(edgeData);edgeFieldData=gaussianBlur(edgeData,8);}
function getEdgeStrength(x,y){if(!edgeData)return 0;const sx=Math.floor((x/canvasWidth)*sourceWidth),sy=Math.floor(((canvasHeight-y)/canvasHeight)*sourceHeight),idx=Math.max(0,Math.min(sourceHeight-1,sy))*sourceWidth+Math.max(0,Math.min(sourceWidth-1,sx));return edgeData[idx]||0;}
function getEdgeGradient(x,y){const field=edgeFieldData||edgeData;if(!field)return{gx:0,gy:0};const step=2;function sample(px,py){const sx=Math.floor((px/canvasWidth)*sourceWidth),sy=Math.floor(((canvasHeight-py)/canvasHeight)*sourceHeight),idx=Math.max(0,Math.min(sourceHeight-1,sy))*sourceWidth+Math.max(0,Math.min(sourceWidth-1,sx));return field[idx]||0;}const eR=sample(x+step,y),eL=sample(x-step,y),eU=sample(x,y-step),eD=sample(x,y+step);let gx=(eR-eL)*0.5,gy=(eD-eU)*0.5;const len=Math.sqrt(gx*gx+gy*gy);if(len>0.001){gx/=len;gy/=len;}return{gx,gy};}

function spawnParticle(index){const key=settings.seed*100000+frameCount*1000+index,pId=particleIdCounter++;let sx,sy;if(settings.spawnType===2&&brightnessSamplerReady){const s=brightnessSamples[Math.floor(hashFloat2(key,100)*brightnessSamples.length)];sx=s.x;sy=s.y;}else{sx=hashRange(key,1,0,canvasWidth);sy=hashRange(key,2,0,canvasHeight);}const br=getBrightness(sx,sy),x=sx-canvasWidth/2,y=sy-canvasHeight/2;let z=0;if(settings.mode>=4){if(settings.spawn3DMode===2)z=(br/255-0.5)*settings.depthScale*2;else if(settings.spawn3DMode===3)z=hashRange(key,3,-settings.depthScale,settings.depthScale);}
// FIX: Copy pixel values since _px is reused
const pixel=getSourcePixel(sx,sy);const pr=pixel.r,pg=pixel.g,pb=pixel.b;
const nf=Math.round(settings.fluct*FLUCT_SCALE),lf=nf>0?Math.floor(hashFluct(pId,2)*nf/128):0,spd=settings.speed*(0.5+hashFloat2(key,4)*0.5);let vx,vy,vz=0;if(settings.dir3DSource===2&&settings.mode>=4){vx=(pr/127.5-1)*spd;vy=(pg/127.5-1)*spd;vz=(pb/127.5-1)*spd;}else{const ch=settings.channel===1?br:pr,ang=(ch/255)*TAU+settings.shift*DEG_TO_RAD+lf*DEG_TO_RAD;vx=Math.cos(ang)*spd;vy=Math.sin(ang)*spd;}const i3=particleCount*3,i4=particleCount*4;positions[i3]=x;positions[i3+1]=y;positions[i3+2]=z;origPositions[i3]=x;origPositions[i3+1]=y;origPositions[i3+2]=z;velocities[i3]=vx;velocities[i3+1]=vy;velocities[i3+2]=vz;particleFluct[particleCount]=lf;particleIds[particleCount]=pId;particleSpeeds[particleCount]=spd;const cm=settings.colorMode;if(cm===1||cm===2){colors[i4]=pr/255;colors[i4+1]=pg/255;colors[i4+2]=pb/255;}else if(cm===3){const c=hexToRgb(settings.customColor);colors[i4]=c.r/255;colors[i4+1]=c.g/255;colors[i4+2]=c.b/255;}else{const c=hexToRgb(settings.startColor);colors[i4]=c.r/255;colors[i4+1]=c.g/255;colors[i4+2]=c.b/255;}colors[i4+3]=1;sizes[particleCount]=settings.size;lifetimes[particleCount]=settings.lifetime;maxLifetimes[particleCount]=settings.lifetime;trailCounts[particleCount]=0;trailHeads[particleCount]=0;particleCount++;}

function updateParticles(){let wi=0;const ar=settings.attrAngle*DEG_TO_RAD,ac=Math.cos(ar),as=Math.sin(ar);let g1=null,g2=null;if(settings.colorMode>=4){g1=hexToRgb(settings.startColor);g2=hexToRgb(settings.endColor);}const updateTrails=(settings.mode===5||settings.mode===3);const edgeOpacityMult=settings.edgeOpacity/100*0.8,edgeSizeMult=settings.edgeSize/100;for(let i=0;i<particleCount;i++){const i3=i*3,i4=i*4;if(--lifetimes[i]<=0)continue;const cx=positions[i3]+canvasWidth/2,cy=positions[i3+1]+canvasHeight/2,spd=particleSpeeds[i];
// FIX: Cache pixel per particle
const pixel=getSourcePixel(cx,cy);const pxR=pixel.r,pxG=pixel.g,pxB=pixel.b;const pxBr=0.2126*pxR+0.7152*pxG+0.0722*pxB;
if(settings.dir3DSource===2&&settings.mode>=4){velocities[i3]=(pxR/127.5-1)*spd;velocities[i3+1]=(pxG/127.5-1)*spd;velocities[i3+2]=(pxB/127.5-1)*spd;}else{const ch=settings.channel===1?pxBr:pxR;let df=0;if(settings.dynFluct>0)df=Math.floor(hashFluct(particleIds[i]*10000+(maxLifetimes[i]-lifetimes[i]),3)*Math.round(settings.dynFluct*FLUCT_SCALE)/128);const ang=(ch/255)*TAU+settings.shift*DEG_TO_RAD+particleFluct[i]*DEG_TO_RAD+df*DEG_TO_RAD;velocities[i3]=Math.cos(ang)*spd;velocities[i3+1]=Math.sin(ang)*spd;}if(settings.attrForce!==0){velocities[i3]+=ac*settings.attrForce*0.1;velocities[i3+1]+=as*settings.attrForce*0.1;}if(settings.edgeAttr>0){const eg=getEdgeGradient(cx,cy),ef=settings.edgeAttr*0.015;velocities[i3]+=eg.gx*ef;velocities[i3+1]-=eg.gy*ef;}if(settings.imgAttr>0&&settings.mode>=4){const s=settings.imgAttr*0.001;velocities[i3]+=(origPositions[i3]-positions[i3])*s;velocities[i3+1]+=(origPositions[i3+1]-positions[i3+1])*s;velocities[i3+2]+=(origPositions[i3+2]-positions[i3+2])*s;}const edge=getEdgeStrength(cx,cy),edgeAlpha=edgeOpacityMult>0?(0.02+edge*0.98)*edgeOpacityMult+(1-edgeOpacityMult):1,edgeSize=settings.size*(1+edge*edgeSizeMult*3.5);if(updateTrails){const tb=i*TRAIL_LENGTH,head=trailHeads[i],ti=tb+head;trailPositions[ti*3]=positions[i3];trailPositions[ti*3+1]=positions[i3+1];trailPositions[ti*3+2]=positions[i3+2];trailColors[ti*4]=colors[i4];trailColors[ti*4+1]=colors[i4+1];trailColors[ti*4+2]=colors[i4+2];trailColors[ti*4+3]=edgeAlpha;trailSizes[ti]=edgeSize;trailHeads[i]=(head+1)%TRAIL_LENGTH;if(trailCounts[i]<TRAIL_LENGTH)trailCounts[i]++;}positions[i3]+=velocities[i3];positions[i3+1]+=velocities[i3+1];positions[i3+2]+=velocities[i3+2];const hw=canvasWidth/2*1.5,hh=canvasHeight/2*1.5,md=settings.depthScale*2;if(Math.abs(positions[i3])>hw||Math.abs(positions[i3+1])>hh||Math.abs(positions[i3+2])>md)continue;const lr=lifetimes[i]/maxLifetimes[i];colors[i4+3]=lr*edgeAlpha;sizes[i]=edgeSize;
if(settings.colorMode===2){colors[i4]=pxR/255;colors[i4+1]=pxG/255;colors[i4+2]=pxB/255;}else if(settings.colorMode===4){const t=1-lr;colors[i4]=(g1.r+(g2.r-g1.r)*t)/255;colors[i4+1]=(g1.g+(g2.g-g1.g)*t)/255;colors[i4+2]=(g1.b+(g2.b-g1.b)*t)/255;}else if(settings.colorMode===5){const t=Math.max(0,Math.min(1,(positions[i3+2]+settings.depthScale)/(settings.depthScale*2)));colors[i4]=(g1.r+(g2.r-g1.r)*t)/255;colors[i4+1]=(g1.g+(g2.g-g1.g)*t)/255;colors[i4+2]=(g1.b+(g2.b-g1.b)*t)/255;}
if(wi!==i){const w3=wi*3,w4=wi*4;positions[w3]=positions[i3];positions[w3+1]=positions[i3+1];positions[w3+2]=positions[i3+2];origPositions[w3]=origPositions[i3];origPositions[w3+1]=origPositions[i3+1];origPositions[w3+2]=origPositions[i3+2];velocities[w3]=velocities[i3];velocities[w3+1]=velocities[i3+1];velocities[w3+2]=velocities[i3+2];colors[w4]=colors[i4];colors[w4+1]=colors[i4+1];colors[w4+2]=colors[i4+2];colors[w4+3]=colors[i4+3];sizes[wi]=sizes[i];lifetimes[wi]=lifetimes[i];maxLifetimes[wi]=maxLifetimes[i];particleFluct[wi]=particleFluct[i];particleIds[wi]=particleIds[i];particleSpeeds[wi]=particleSpeeds[i];const stb=i*TRAIL_LENGTH,dtb=wi*TRAIL_LENGTH;for(let t=0;t<TRAIL_LENGTH;t++){trailPositions[(dtb+t)*3]=trailPositions[(stb+t)*3];trailPositions[(dtb+t)*3+1]=trailPositions[(stb+t)*3+1];trailPositions[(dtb+t)*3+2]=trailPositions[(stb+t)*3+2];trailColors[(dtb+t)*4]=trailColors[(stb+t)*4];trailColors[(dtb+t)*4+1]=trailColors[(stb+t)*4+1];trailColors[(dtb+t)*4+2]=trailColors[(stb+t)*4+2];trailColors[(dtb+t)*4+3]=trailColors[(stb+t)*4+3];trailSizes[dtb+t]=trailSizes[stb+t];}trailCounts[wi]=trailCounts[i];trailHeads[wi]=trailHeads[i];}wi++;}particleCount=wi;}
function renderParticles(toFB){const colorKey=settings.bgColor;if(cachedColors.bg!==colorKey){cachedColors.bg=colorKey;cachedColors.bgRgb=hexToRgb(colorKey);}const bg=cachedColors.bgRgb;if(toFB){gl.bindFramebuffer(gl.FRAMEBUFFER,framebufferMain);gl.viewport(0,0,canvasWidth,canvasHeight);}gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.clearColor(settings.transparentBg?0:bg.r/255,settings.transparentBg?0:bg.g/255,settings.transparentBg?0:bg.b/255,settings.transparentBg?0:(settings.mode===3||settings.mode===5)&&settings.fade>0?settings.fade/255:1);gl.clear(gl.COLOR_BUFFER_BIT);if(particleCount===0)return;gl.useProgram(program);let proj,view;if(settings.mode>=4){proj=perspectiveMatrix(settings.fov,canvasWidth/canvasHeight,1,5000);view=viewMatrix(camRotX,camRotY,settings.camDist);}else{proj=orthoMatrix(-canvasWidth/2,canvasWidth/2,-canvasHeight/2,canvasHeight/2,-1000,1000);view=identityMatrix();}gl.uniformMatrix4fv(uProjection,false,proj);gl.uniformMatrix4fv(uView,false,view);gl.uniform2f(uResolution,canvasWidth,canvasHeight);gl.uniform1f(uIs3D,settings.mode>=4?1:0);
// FIX: bufferSubData instead of bufferData for pre-allocated buffers
if(settings.mode!==3){gl.bindBuffer(gl.ARRAY_BUFFER,positionBuffer);gl.bufferSubData(gl.ARRAY_BUFFER,0,positions.subarray(0,particleCount*3));gl.enableVertexAttribArray(mainLocs.aPos);gl.vertexAttribPointer(mainLocs.aPos,3,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,colorBuffer);gl.bufferSubData(gl.ARRAY_BUFFER,0,colors.subarray(0,particleCount*4));gl.enableVertexAttribArray(mainLocs.aCol);gl.vertexAttribPointer(mainLocs.aCol,4,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,sizeBuffer);gl.bufferSubData(gl.ARRAY_BUFFER,0,sizes.subarray(0,particleCount));gl.enableVertexAttribArray(mainLocs.aSiz);gl.vertexAttribPointer(mainLocs.aSiz,1,gl.FLOAT,false,0,0);gl.drawArrays(gl.POINTS,0,particleCount);}if(settings.mode===3||settings.mode===5)renderTrails(proj,view);if(toFB)gl.bindFramebuffer(gl.FRAMEBUFFER,null);}

function applyGlow(){if(!glowProgram)return;const hw=canvasWidth/2,hh=canvasHeight/2;gl.useProgram(glowProgram);gl.bindBuffer(gl.ARRAY_BUFFER,quadBuffer);gl.enableVertexAttribArray(glowLocs.aPos);gl.vertexAttribPointer(glowLocs.aPos,2,gl.FLOAT,false,0,0);gl.disable(gl.BLEND);for(let p=0;p<2;p++){const spread=(p+1)*settings.glowRadius/2;gl.bindFramebuffer(gl.FRAMEBUFFER,framebufferA);gl.viewport(0,0,hw,hh);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,p===0?textureMain:textureB);gl.uniform1i(glowLocs.uTex,0);gl.uniform2f(glowLocs.uDir,spread,0);gl.uniform2f(glowLocs.uRes,hw,hh);gl.drawArrays(gl.TRIANGLE_STRIP,0,4);gl.bindFramebuffer(gl.FRAMEBUFFER,framebufferB);gl.bindTexture(gl.TEXTURE_2D,textureA);gl.uniform2f(glowLocs.uDir,0,spread);gl.drawArrays(gl.TRIANGLE_STRIP,0,4);}gl.enable(gl.BLEND);}
function compositeGlow(){if(!compositeProgram)return;gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(0,0,canvasWidth,canvasHeight);gl.useProgram(compositeProgram);gl.bindBuffer(gl.ARRAY_BUFFER,quadBuffer);gl.enableVertexAttribArray(compositeLocs.aPos);gl.vertexAttribPointer(compositeLocs.aPos,2,gl.FLOAT,false,0,0);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,textureMain);gl.uniform1i(compositeLocs.uOrig,0);gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,textureB);gl.uniform1i(compositeLocs.uGlow,1);gl.uniform1f(compositeLocs.uInt,settings.glowIntensity);gl.blendFunc(gl.ONE,gl.ZERO);gl.drawArrays(gl.TRIANGLE_STRIP,0,4);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);}
function render(){if(settings.glowEnabled&&particleCount>0){renderParticles(true);applyGlow();compositeGlow();}else{renderParticles(false);}}

function renderTrails(proj,view){if(particleCount===0||!lineProgram)return;let segCount=0;for(let i=0;i<particleCount;i++)if(trailCounts[i]>1)segCount+=trailCounts[i]-1;if(segCount===0)return;let vi=0;for(let i=0;i<particleCount;i++){const c=trailCounts[i];if(c<2)continue;const tb=i*TRAIL_LENGTH,head=trailHeads[i];for(let j=0;j<c-1;j++){const idx1=tb+((head-c+j+TRAIL_LENGTH)%TRAIL_LENGTH),idx2=tb+((head-c+j+1+TRAIL_LENGTH)%TRAIL_LENGTH);const x1=trailPositions[idx1*3],y1=trailPositions[idx1*3+1],z1=trailPositions[idx1*3+2],x2=trailPositions[idx2*3],y2=trailPositions[idx2*3+1],z2=trailPositions[idx2*3+2];const dx=x2-x1,dy=y2-y1,len=Math.sqrt(dx*dx+dy*dy)||1;const t1=trailSizes[idx1]*0.25,t2=trailSizes[idx2]*0.25,nx1=-dy/len*t1,ny1=dx/len*t1,nx2=-dy/len*t2,ny2=dx/len*t2;const fp1=((j+1)/c)*0.9,fp2=((j+2)/c)*0.9,a1=trailColors[idx1*4+3]*fp1,a2=trailColors[idx2*4+3]*fp2;const r1=trailColors[idx1*4],g1=trailColors[idx1*4+1],b1=trailColors[idx1*4+2],r2=trailColors[idx2*4],g2_=trailColors[idx2*4+1],b2=trailColors[idx2*4+2];trailTriPos[vi*3]=x1+nx1;trailTriPos[vi*3+1]=y1+ny1;trailTriPos[vi*3+2]=z1;trailTriCol[vi*4]=r1;trailTriCol[vi*4+1]=g1;trailTriCol[vi*4+2]=b1;trailTriCol[vi*4+3]=a1;vi++;trailTriPos[vi*3]=x1-nx1;trailTriPos[vi*3+1]=y1-ny1;trailTriPos[vi*3+2]=z1;trailTriCol[vi*4]=r1;trailTriCol[vi*4+1]=g1;trailTriCol[vi*4+2]=b1;trailTriCol[vi*4+3]=a1;vi++;trailTriPos[vi*3]=x2+nx2;trailTriPos[vi*3+1]=y2+ny2;trailTriPos[vi*3+2]=z2;trailTriCol[vi*4]=r2;trailTriCol[vi*4+1]=g2_;trailTriCol[vi*4+2]=b2;trailTriCol[vi*4+3]=a2;vi++;trailTriPos[vi*3]=x2+nx2;trailTriPos[vi*3+1]=y2+ny2;trailTriPos[vi*3+2]=z2;trailTriCol[vi*4]=r2;trailTriCol[vi*4+1]=g2_;trailTriCol[vi*4+2]=b2;trailTriCol[vi*4+3]=a2;vi++;trailTriPos[vi*3]=x1-nx1;trailTriPos[vi*3+1]=y1-ny1;trailTriPos[vi*3+2]=z1;trailTriCol[vi*4]=r1;trailTriCol[vi*4+1]=g1;trailTriCol[vi*4+2]=b1;trailTriCol[vi*4+3]=a1;vi++;trailTriPos[vi*3]=x2-nx2;trailTriPos[vi*3+1]=y2-ny2;trailTriPos[vi*3+2]=z2;trailTriCol[vi*4]=r2;trailTriCol[vi*4+1]=g2_;trailTriCol[vi*4+2]=b2;trailTriCol[vi*4+3]=a2;vi++;}}gl.useProgram(lineProgram);gl.uniformMatrix4fv(lineLocs.uProj,false,proj);gl.uniformMatrix4fv(lineLocs.uView,false,view);gl.bindBuffer(gl.ARRAY_BUFFER,positionBuffer);gl.bufferData(gl.ARRAY_BUFFER,trailTriPos.subarray(0,vi*3),gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(lineLocs.aPos);gl.vertexAttribPointer(lineLocs.aPos,3,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,colorBuffer);gl.bufferData(gl.ARRAY_BUFFER,trailTriCol.subarray(0,vi*4),gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(lineLocs.aCol);gl.vertexAttribPointer(lineLocs.aCol,4,gl.FLOAT,false,0,0);gl.drawArrays(gl.TRIANGLES,0,vi);gl.useProgram(program);}

function renderStaticTrails(){const colorKey=settings.bgColor+settings.startColor+settings.endColor+settings.customColor;if(cachedColors.key!==colorKey){cachedColors.key=colorKey;cachedColors.bg2=hexToRgb(settings.bgColor);cachedColors.g1=hexToRgb(settings.startColor);cachedColors.g2=hexToRgb(settings.endColor);cachedColors.cc=hexToRgb(settings.customColor);}const bg=cachedColors.bg2,g1=cachedColors.g1,g2=cachedColors.g2,cc=cachedColors.cc;if(settings.glowEnabled){gl.bindFramebuffer(gl.FRAMEBUFFER,framebufferMain);gl.viewport(0,0,canvasWidth,canvasHeight);}gl.clearColor(settings.transparentBg?0:bg.r/255,settings.transparentBg?0:bg.g/255,settings.transparentBg?0:bg.b/255,settings.transparentBg?0:1);gl.clear(gl.COLOR_BUFFER_BIT);gl.useProgram(program);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.uniformMatrix4fv(uProjection,false,orthoMatrix(-canvasWidth/2,canvasWidth/2,-canvasHeight/2,canvasHeight/2,-1000,1000));gl.uniformMatrix4fv(uView,false,identityMatrix());gl.uniform2f(uResolution,canvasWidth,canvasHeight);gl.uniform1f(uIs3D,0);const arRad=settings.attrAngle*DEG_TO_RAD,ac=fastCos(arRad),as=fastSin(arRad),maxSteps=(settings.lifetime*settings.speed)|0,edgeOpacityMult=settings.edgeOpacity/100*0.8,edgeSizeMult=settings.edgeSize/100,edgeAttrF=settings.edgeAttr*0.015,shiftRad=settings.shift*DEG_TO_RAD,nf=Math.round(settings.fluct*FLUCT_SCALE),dynFluctNf=Math.round(settings.dynFluct*FLUCT_SCALE),useEdgeAttr=edgeAttrF>0&&edgeData,useDynFluct=settings.dynFluct>0,useAttrForce=settings.attrForce!==0,attrFX=ac*settings.attrForce*0.1,attrFY=as*settings.attrForce*0.1,cm=settings.colorMode,hwC=canvasWidth/2,hhC=canvasHeight/2,g1r=g1.r,g1g=g1.g,g1b=g1.b,g2r=g2.r-g1r,g2g=g2.g-g1g,g2b=g2.b-g1b,ccr=cc.r/255,ccg=cc.g/255,ccb=cc.b/255,baseSize=settings.size,sizeMult=edgeSizeMult*3.5,sxMult=sourceWidth/canvasWidth,syMult=sourceHeight/canvasHeight,swM1=sourceWidth-1,shM1=sourceHeight-1,hasSource=!!sourceData,hasEdge=!!edgeData;let pi=0;for(let i=0;i<settings.count&&pi<STATIC_MAX;i++){const key=settings.seed*10000+i;let sx,sy;if(settings.spawnType===2&&brightnessSamplerReady){const s=brightnessSamples[(hashFloat2(key,100)*brightnessSamples.length)|0];sx=s.x;sy=s.y;}else{sx=hashRange(key,1,0,canvasWidth);sy=hashRange(key,2,0,canvasHeight);}let x=sx-hwC,y=sy-hhC;let spr=0.5,spg=0.5,spb=0.5;if(hasSource){const psx=(sx*sxMult)|0,psy=((canvasHeight-sy)*syMult)|0,pidx=((psy<0?0:psy>shM1?shM1:psy)*sourceWidth+(psx<0?0:psx>swM1?swM1:psx))*4;spr=sourceData[pidx]/255;spg=sourceData[pidx+1]/255;spb=sourceData[pidx+2]/255;}const spd=settings.speed*(0.5+hashFloat2(key,3)*0.5),lf=nf>0?(hashFluct(key,2)*nf/128)|0:0,lfRad=lf*DEG_TO_RAD;for(let step=0;step<maxSteps&&pi<STATIC_MAX;step++){const cx=x+hwC,cy=y+hhC;if(cx<0||cx>=canvasWidth||cy<0||cy>=canvasHeight)break;let pr=128,pg2=128,pb=128;if(hasSource){const psx=(cx*sxMult)|0,psy=((canvasHeight-cy)*syMult)|0,pidx=((psy<0?0:psy>shM1?shM1:psy)*sourceWidth+(psx<0?0:psx>swM1?swM1:psx))*4;pr=sourceData[pidx];pg2=sourceData[pidx+1];pb=sourceData[pidx+2];}const br=0.2126*pr+0.7152*pg2+0.0722*pb,ch=settings.channel===1?br:pr;let df=0;if(useDynFluct)df=(hashFluct(key*10000+step,3)*dynFluctNf/128)|0;const ang=(ch/255)*TAU+shiftRad+lfRad+df*DEG_TO_RAD;let edge=0;if(hasEdge){const esx=(cx*sxMult)|0,esy=((canvasHeight-cy)*syMult)|0,eidx=(esy<0?0:esy>shM1?shM1:esy)*sourceWidth+(esx<0?0:esx>swM1?swM1:esx);edge=edgeData[eidx]||0;}const edgeAlpha=edgeOpacityMult>0?(0.02+edge*0.98)*edgeOpacityMult+(1-edgeOpacityMult):1,edgeSize2=baseSize*(1+edge*sizeMult);const pi3=pi*3,pi4=pi*4;staticPos[pi3]=x;staticPos[pi3+1]=y;staticPos[pi3+2]=0;const t=step/maxSteps;if(cm===1){staticCol[pi4]=spr;staticCol[pi4+1]=spg;staticCol[pi4+2]=spb;}else if(cm===2){staticCol[pi4]=pr/255;staticCol[pi4+1]=pg2/255;staticCol[pi4+2]=pb/255;}else if(cm===4){staticCol[pi4]=(g1r+g2r*t)/255;staticCol[pi4+1]=(g1g+g2g*t)/255;staticCol[pi4+2]=(g1b+g2b*t)/255;}else{staticCol[pi4]=ccr;staticCol[pi4+1]=ccg;staticCol[pi4+2]=ccb;}staticCol[pi4+3]=(1-t)*edgeAlpha;staticSiz[pi]=edgeSize2;pi++;let vx=fastCos(ang)*spd,vy=fastSin(ang)*spd;if(useAttrForce){vx+=attrFX;vy+=attrFY;}if(useEdgeAttr){const eg=getEdgeGradient(cx,cy);vx+=eg.gx*edgeAttrF;vy-=eg.gy*edgeAttrF;}x+=vx;y+=vy;}}gl.bindBuffer(gl.ARRAY_BUFFER,positionBuffer);gl.bufferData(gl.ARRAY_BUFFER,staticPos.subarray(0,pi*3),gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(mainLocs.aPos);gl.vertexAttribPointer(mainLocs.aPos,3,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,colorBuffer);gl.bufferData(gl.ARRAY_BUFFER,staticCol.subarray(0,pi*4),gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(mainLocs.aCol);gl.vertexAttribPointer(mainLocs.aCol,4,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,sizeBuffer);gl.bufferData(gl.ARRAY_BUFFER,staticSiz.subarray(0,pi),gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(mainLocs.aSiz);gl.vertexAttribPointer(mainLocs.aSiz,1,gl.FLOAT,false,0,0);gl.drawArrays(gl.POINTS,0,pi);if(settings.glowEnabled){gl.bindFramebuffer(gl.FRAMEBUFFER,null);applyGlow();compositeGlow();}}

function mainLoop(){frameCount++;const now=performance.now();if(now-lastTime>=FPS_INTERVAL){fps=Math.round(frameCount/((now-lastTime)/1000));const fe=document.getElementById('fpsDisplay');if(fe)fe.textContent=fps;const pe=document.getElementById('particleCount');if(pe)pe.textContent=particleCount;const mf=document.getElementById('mobileFps');if(mf)mf.textContent=fps;const mp=document.getElementById('mobileParticleCount');if(mp)mp.textContent=particleCount;frameCount=0;lastTime=now;}if(useWebcam)updateFromWebcam();if(settings.mode===2){renderStaticTrails();}else{const spawn=Math.min(settings.count,MAX_PARTICLES-particleCount);for(let i=0;i<spawn;i++)spawnParticle(i);updateParticles();render();}requestAnimationFrame(mainLoop);}

// FIX: noiseHash uses Math.abs for positive values
function noiseHash(x,y,s){return Math.abs((Math.sin(x*12.9898+y*78.233+s)*NOISE_MAGIC)%1);}
function smoothNoise(x,y,s){const ix=Math.floor(x),iy=Math.floor(y),fx=x-ix,fy=y-iy,a=noiseHash(ix,iy,s),b=noiseHash(ix+1,iy,s),c=noiseHash(ix,iy+1,s),d=noiseHash(ix+1,iy+1,s),ux=fx*fx*(3-2*fx),uy=fy*fy*(3-2*fy);return a*(1-ux)*(1-uy)+b*ux*(1-uy)+c*(1-ux)*uy+d*ux*uy;}
function fractalNoise(x,y,s,o=4){let v=0,a=0.5,f=1,m=0;for(let i=0;i<o;i++){v+=smoothNoise(x*f,y*f,s+i*100)*a;m+=a;a*=0.5;f*=2;}return v/m;}
function createNoiseMap(){const w=512,h=288,d=new Uint8Array(w*h*4),sc=0.02;for(let y=0;y<h;y++)for(let x=0;x<w;x++){const i=(y*w+x)*4;d[i]=Math.floor(fractalNoise(x*sc,y*sc,settings.seed)*255);d[i+1]=Math.floor(fractalNoise(x*sc,y*sc,settings.seed+1000)*255);d[i+2]=Math.floor(fractalNoise(x*sc,y*sc,settings.seed+2000)*255);d[i+3]=255;}sourceData=d;sourceWidth=w;sourceHeight=h;computeEdgeMap();updateCanvasSize();updatePreview();}
function createGradientMap(){const w=512,h=288,d=new Uint8Array(w*h*4);for(let y=0;y<h;y++)for(let x=0;x<w;x++){const i=(y*w+x)*4,v=Math.floor((x/w)*255);d[i]=v;d[i+1]=v;d[i+2]=v;d[i+3]=255;}sourceData=d;sourceWidth=w;sourceHeight=h;computeEdgeMap();updateCanvasSize();updatePreview();}
function createRadialMap(){const w=512,h=288,d=new Uint8Array(w*h*4),cx=w/2,cy=h/2;for(let y=0;y<h;y++)for(let x=0;x<w;x++){const i=(y*w+x)*4,dx=x-cx,dy=y-cy,l=Math.sqrt(dx*dx+dy*dy)||1;d[i]=Math.floor((dx/l*0.5+0.5)*255);d[i+1]=Math.floor((dy/l*0.5+0.5)*255);d[i+2]=Math.floor(0.6*255);d[i+3]=255;}sourceData=d;sourceWidth=w;sourceHeight=h;computeEdgeMap();updateCanvasSize();updatePreview();}
function create3DFlowMap(){const w=512,h=288,d=new Uint8Array(w*h*4),cx=w/2,cy=h/2,md=Math.min(w,h)*0.5;for(let y=0;y<h;y++)for(let x=0;x<w;x++){const i=(y*w+x)*4,dx=x-cx,dy=y-cy,dist=Math.sqrt(dx*dx+dy*dy)/md,ang=Math.atan2(dy,dx),tx=-Math.sin(ang),ty=Math.cos(ang),turb=fractalNoise(x*0.02,y*0.02,settings.seed,3),zf=Math.sin(dist*4+settings.seed*0.1)*0.5;d[i]=Math.floor(((tx*0.7+(turb-0.5)*0.6)*0.5+0.5)*255);d[i+1]=Math.floor(((ty*0.7+(turb-0.5)*0.6)*0.5+0.5)*255);d[i+2]=Math.floor((zf*0.5+0.5)*255);d[i+3]=255;}sourceData=d;sourceWidth=w;sourceHeight=h;computeEdgeMap();updateCanvasSize();updatePreview();}
// FIX: Reuse offscreen canvas for preview
function updatePreview(){}

// FIX: Reusable offscreen canvas for webcam; debounced flipCamera
function loadSampleImage(){const img=new Image();img.onload=()=>{const c=document.createElement('canvas');c.width=img.width;c.height=img.height;const ctx=c.getContext('2d');ctx.drawImage(img,0,0);sourceData=new Uint8Array(ctx.getImageData(0,0,img.width,img.height).data);sourceWidth=img.width;sourceHeight=img.height;computeEdgeMap();updateCanvasSize();applyPreset('particles');};img.onerror=()=>create3DFlowMap();img.src='sample.jpg';}
async function startWebcam(facingMode='user'){try{if(webcam){webcam.srcObject?.getTracks().forEach(t=>t.stop());webcam=null;}const stream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:WEBCAM_SIZE},height:{ideal:WEBCAM_SIZE},facingMode:facingMode},audio:false});webcam=document.createElement('video');webcam.srcObject=stream;webcam.setAttribute('playsinline','');webcam.muted=true;await webcam.play();useWebcam=true;cameraFacingMode=facingMode;sourceWidth=WEBCAM_SIZE;sourceHeight=WEBCAM_SIZE;updateCanvasSize();document.getElementById('webcamBtn').classList.add('active');document.getElementById('mobileWebcamBtn').classList.add('active');document.getElementById('mobileFlipCamBtn').style.display='flex';return true;}catch(e){loadSampleImage();return false;}}
function stopWebcam(){if(webcam){webcam.srcObject?.getTracks().forEach(t=>t.stop());webcam=null;}useWebcam=false;document.getElementById('webcamBtn').classList.remove('active');document.getElementById('mobileWebcamBtn').classList.remove('active');document.getElementById('mobileFlipCamBtn').style.display='none';}
async function flipCamera(){if(isFlippingCamera)return;isFlippingCamera=true;try{await startWebcam(cameraFacingMode==='user'?'environment':'user');}finally{isFlippingCamera=false;}}
function updateFromWebcam(){if(!webcam||!useWebcam)return;const ctx=getWcCanvas(WEBCAM_SIZE,WEBCAM_SIZE);if(cameraFacingMode==='user'){ctx.save();ctx.translate(WEBCAM_SIZE,0);ctx.scale(-1,1);}ctx.drawImage(webcam,0,0,WEBCAM_SIZE,WEBCAM_SIZE);if(cameraFacingMode==='user')ctx.restore();sourceData=new Uint8Array(ctx.getImageData(0,0,WEBCAM_SIZE,WEBCAM_SIZE).data);sourceWidth=WEBCAM_SIZE;sourceHeight=WEBCAM_SIZE;if(++edgeFrameCount%2===0)computeEdgeMap();}

// FIX: Check mime type support, revoke blob URLs
function startRecording(){recordedChunks=[];const stream=canvas.captureStream(30);const mimes=['video/mp4;codecs=avc1,opus','video/mp4;codecs=avc1','video/mp4','video/webm;codecs=vp9','video/webm;codecs=vp8','video/webm'];let mime='';for(const m of mimes){if(MediaRecorder.isTypeSupported(m)){mime=m;break;}}if(!mime){showToast('Recording not supported');return;}try{mediaRecorder=new MediaRecorder(stream,{mimeType:mime});}catch(e){showToast('Recording failed');return;}mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recordedChunks.push(e.data);};mediaRecorder.onstop=()=>{const ext=mime.includes('mp4')?'mp4':'webm';const blob=new Blob(recordedChunks,{type:mime});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`vectory-${Date.now()}.${ext}`;a.click();setTimeout(()=>URL.revokeObjectURL(url),1000);showToast('Video saved!');};mediaRecorder.start();document.getElementById('recordBtn').classList.add('recording');document.getElementById('mobileRecordBtn').classList.add('recording');}
function stopRecording(){if(mediaRecorder&&mediaRecorder.state!=='inactive')mediaRecorder.stop();document.getElementById('recordBtn').classList.remove('recording');document.getElementById('mobileRecordBtn').classList.remove('recording');}
function toggleRecording(){mediaRecorder&&mediaRecorder.state==='recording'?stopRecording():startRecording();}
// FIX: Use toBlob (async, non-blocking) + revoke URL
function saveImage(){showFlash();playSound();canvas.toBlob(blob=>{if(!blob){showToast('Save failed');return;}const url=URL.createObjectURL(blob);const a=document.createElement('a');a.download=`vectory-${Date.now()}.png`;a.href=url;a.click();setTimeout(()=>URL.revokeObjectURL(url),1000);showToast('Image saved!');},'image/png');}
function getCanvasBlob(){return new Promise(r=>canvas.toBlob(b=>r(b),'image/png'));}
function closeShareDropdown(){document.getElementById('shareDropdown').style.display='none';}
async function shareToSocial(url){showFlash();const blob=await getCanvasBlob();if(blob){const u=URL.createObjectURL(blob);const a=document.createElement('a');a.href=u;a.download='vectory-'+Date.now()+'.png';a.click();setTimeout(()=>URL.revokeObjectURL(u),1000);}window.open(url,'_blank');closeShareDropdown();showToast('Image saved!');}
async function shareImage(){try{const blob=await getCanvasBlob();if(!blob){if(window.innerWidth>900){const dd=document.getElementById('shareDropdown');dd.style.display=dd.style.display==='none'?'block':'none';}else saveImage();return;}const file=new File([blob],'vectory.png',{type:'image/png'});if(navigator.canShare&&navigator.canShare({files:[file]})){await navigator.share({files:[file],title:'Vectory',text:location.href});return;}if(window.innerWidth>900){const dd=document.getElementById('shareDropdown');dd.style.display=dd.style.display==='none'?'block':'none';}else saveImage();}catch(e){if(e.name!=='AbortError'){if(window.innerWidth>900){const dd=document.getElementById('shareDropdown');dd.style.display=dd.style.display==='none'?'block':'none';}else saveImage();}}}
function toggleFullscreen(){if(document.fullscreenElement)document.exitFullscreen();else document.documentElement.requestFullscreen();}
function resetParticles(){particleCount=0;particleIdCounter=0;for(let i=0;i<MAX_PARTICLES;i++){trailCounts[i]=0;trailHeads[i]=0;}buildBrightnessSampler();}
function applyPreset(name){const p=presets[name];if(!p)return;Object.assign(settings,defaultSettings,p);if(window.innerWidth<=900&&settings.mode>=4)settings.camDist=1000;syncUI();resetParticles();currentPresetIndex=presetNames.indexOf(name);updateMobilePresetButtons();showToast(`${name} preset`);}
function updateMobilePresetButtons(){document.querySelectorAll('.desktop-presets button').forEach(btn=>{btn.classList.toggle('active',btn.dataset.preset===presetNames[currentPresetIndex]);});}
function syncUI(){const map=[['count','count'],['size','size'],['speed','speed']];for(const[id,key]of map){const el=document.getElementById(id);if(!el)continue;el.value=settings[key];const v=document.getElementById(id+'Val');if(v)v.textContent=fmtVal(settings[key]);}['qSpeed','qSize','qCount'].forEach(qId=>{const mainId=qId.charAt(1).toLowerCase()+qId.slice(2);const el=document.getElementById(qId);if(el){el.value=settings[mainId];const v=document.getElementById(qId+'Val');if(v)v.textContent=fmtVal(settings[mainId]);}});document.getElementById('rotateHint').classList.toggle('hidden',settings.mode<4||hintInteracted);}

function setupMouseControls(){canvas.addEventListener('mousedown',e=>{if(settings.mode>=4){isDragging=true;lastMouseX=e.clientX;lastMouseY=e.clientY;hintInteracted=true;document.getElementById('rotateHint').classList.add('hidden');}});document.addEventListener('mouseup',()=>isDragging=false);document.addEventListener('mousemove',e=>{if(isDragging&&settings.mode>=4){camRotY+=(e.clientX-lastMouseX)*0.01;camRotX+=(e.clientY-lastMouseY)*0.01;camRotX=Math.max(-Math.PI/2,Math.min(Math.PI/2,camRotX));lastMouseX=e.clientX;lastMouseY=e.clientY;}});
canvas.addEventListener('touchstart',e=>{if(e.touches.length===1){swipeStartX=e.touches[0].clientX;swipeStartY=e.touches[0].clientY;isSwiping=true;if(settings.mode>=4){isDragging=true;lastMouseX=e.touches[0].clientX;lastMouseY=e.touches[0].clientY;hintInteracted=true;}}else if(e.touches.length===2&&settings.mode>=4){e.preventDefault();isDragging=false;isSwiping=false;lastPinchDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);}},{passive:false});
canvas.addEventListener('touchmove',e=>{if(e.touches.length===1){const dx=e.touches[0].clientX-swipeStartX,dy=e.touches[0].clientY-swipeStartY;if(window.innerWidth<=900&&isSwiping&&Math.abs(dx)>30&&Math.abs(dx)>Math.abs(dy)){document.getElementById('swipeLeft').classList.toggle('visible',dx>0&&currentPresetIndex>0);document.getElementById('swipeRight').classList.toggle('visible',dx<0&&currentPresetIndex<presetNames.length-1);}if(settings.mode>=4&&isDragging&&Math.abs(dy)>Math.abs(dx)){camRotY+=(e.touches[0].clientX-lastMouseX)*0.01;camRotX+=(e.touches[0].clientY-lastMouseY)*0.01;camRotX=Math.max(-Math.PI/2,Math.min(Math.PI/2,camRotX));lastMouseX=e.touches[0].clientX;lastMouseY=e.touches[0].clientY;isSwiping=false;}}else if(e.touches.length===2&&settings.mode>=4){e.preventDefault();const pd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);if(lastPinchDist>0){settings.camDist=Math.max(100,Math.min(1000,settings.camDist*(lastPinchDist/pd)));}lastPinchDist=pd;}},{passive:false});
canvas.addEventListener('touchend',e=>{document.getElementById('swipeLeft').classList.remove('visible');document.getElementById('swipeRight').classList.remove('visible');const dx=e.changedTouches[0].clientX-swipeStartX,dy=e.changedTouches[0].clientY-swipeStartY;if(isSwiping&&window.innerWidth<=900){if(Math.abs(dx)>60&&Math.abs(dx)>Math.abs(dy)*1.5){const hint=document.getElementById('mobileSwipeHint');if(hint)hint.classList.add('hidden');if(dx>0&&currentPresetIndex>0)applyPreset(presetNames[currentPresetIndex-1]);else if(dx<0&&currentPresetIndex<presetNames.length-1)applyPreset(presetNames[currentPresetIndex+1]);}}if(window.innerWidth<=900&&Math.abs(dx)<15&&Math.abs(dy)<15)document.getElementById('quickSettings').classList.remove('visible');isDragging=false;isSwiping=false;if(e.touches.length<2)lastPinchDist=0;});
canvas.addEventListener('wheel',e=>{if(settings.mode>=4){e.preventDefault();hintInteracted=true;settings.camDist=Math.max(100,Math.min(1000,settings.camDist*(e.deltaY>0?1.1:0.9)));}},{passive:false});}

document.addEventListener('keydown',e=>{if(e.key==='f'||e.key==='F')toggleFullscreen();if(e.key==='s'&&(e.metaKey||e.ctrlKey)){e.preventDefault();saveImage();}});

function setupMobileUI(){document.getElementById('mobileSettingsBtn').addEventListener('click',()=>document.getElementById('quickSettings').classList.toggle('visible'));document.getElementById('mobileWebcamBtn').addEventListener('click',()=>{if(useWebcam){stopWebcam();loadSampleImage();}else startWebcam();});document.getElementById('mobileFlipCamBtn').addEventListener('click',flipCamera);document.getElementById('mobileSaveBtn').addEventListener('click',saveImage);document.getElementById('mobileRecordBtn').addEventListener('click',toggleRecording);document.getElementById('mobileShareBtn').addEventListener('click',shareImage);document.getElementById('closeQuickSettings').addEventListener('click',()=>document.getElementById('quickSettings').classList.remove('visible'));
function syncQ(qId,mainId){document.getElementById(qId).addEventListener('input',e=>{settings[mainId]=+e.target.value;document.getElementById(qId+'Val').textContent=settings[mainId];document.getElementById(mainId).value=settings[mainId];const v=document.getElementById(mainId+'Val');if(v)v.textContent=settings[mainId];});}syncQ('qSpeed','speed');syncQ('qSize','size');syncQ('qCount','count');
let statTimeout;canvas.addEventListener('click',()=>{const stats=document.getElementById('mobileStats');stats.classList.add('visible');clearTimeout(statTimeout);statTimeout=setTimeout(()=>stats.classList.remove('visible'),2000);});}

function fmtVal(v){return v%1===0?String(v):v.toFixed(1);}
function setupControls(){const upd=(id)=>{const v=document.getElementById(id+'Val');if(v)v.textContent=fmtVal(+document.getElementById(id).value);};document.querySelectorAll('[data-preset]').forEach(btn=>btn.addEventListener('click',()=>applyPreset(btn.dataset.preset)));document.getElementById('webcamBtn').addEventListener('click',()=>{if(useWebcam){stopWebcam();loadSampleImage();}else startWebcam();});document.getElementById('size').addEventListener('input',e=>{settings.size=+e.target.value;upd('size');const q=document.getElementById('qSize');if(q)q.value=settings.size;const qv=document.getElementById('qSizeVal');if(qv)qv.textContent=fmtVal(settings.size);});document.getElementById('speed').addEventListener('input',e=>{settings.speed=+e.target.value;upd('speed');const q=document.getElementById('qSpeed');if(q)q.value=settings.speed;const qv=document.getElementById('qSpeedVal');if(qv)qv.textContent=fmtVal(settings.speed);});document.getElementById('count').addEventListener('input',e=>{settings.count=+e.target.value;upd('count');const q=document.getElementById('qCount');if(q)q.value=settings.count;const qv=document.getElementById('qCountVal');if(qv)qv.textContent=fmtVal(settings.count);});document.getElementById('recordBtn').addEventListener('click',toggleRecording);document.getElementById('saveBtn').addEventListener('click',saveImage);document.getElementById('shareBtn').addEventListener('click',shareImage);document.getElementById('fullscreenBtn').addEventListener('click',toggleFullscreen);
document.getElementById('desktopSettingsBtn').addEventListener('click',()=>{document.getElementById('desktopQuickSettings').classList.toggle('visible');});
document.getElementById('shareTelegram').addEventListener('click',()=>shareToSocial('https://t.me/share/url?url='+encodeURIComponent(location.href)));
document.getElementById('shareTwitter').addEventListener('click',()=>shareToSocial('https://x.com/intent/tweet?url='+encodeURIComponent(location.href)));
document.addEventListener('click',e=>{if(!e.target.closest('.share-anchor'))closeShareDropdown();if(!e.target.closest('.desktop-settings-anchor')){const dqs=document.getElementById('desktopQuickSettings');if(dqs)dqs.classList.remove('visible');}});
syncUI();}

// FIX: devicePixelRatio support
function updateCanvasSize(){const cont=document.getElementById('canvas-container'),isMobile=window.innerWidth<=900;dpr=Math.min(window.devicePixelRatio||1,2);if(isMobile){const ar=sourceWidth&&sourceHeight?sourceWidth/sourceHeight:16/9;const sw=window.innerWidth,sh=window.innerHeight,screenAR=sw/sh;if(screenAR>ar){canvasWidth=Math.round(sw*dpr);canvasHeight=Math.round(sw/ar*dpr);}else{canvasHeight=Math.round(sh*dpr);canvasWidth=Math.round(sh*ar*dpr);}}else{const tb=document.getElementById('desktopToolbar');const tbH=tb?tb.offsetHeight+24:80;const p=24,mw=cont.clientWidth-p,mh=cont.clientHeight-tbH,ar=sourceWidth&&sourceHeight?sourceWidth/sourceHeight:16/9;if(mw/mh>ar){canvasHeight=mh;canvasWidth=Math.round(canvasHeight*ar);}else{canvasWidth=mw;canvasHeight=Math.round(canvasWidth/ar);}canvasWidth=Math.max(200,Math.round(canvasWidth*dpr));canvasHeight=Math.max(150,Math.round(canvasHeight*dpr));}if(canvas){canvas.width=canvasWidth;canvas.height=canvasHeight;if(isMobile){canvas.style.width='100%';canvas.style.height='100%';canvas.style.objectFit='cover';canvas.style.position='';canvas.style.left='';canvas.style.top='';}else{canvas.style.width=Math.round(canvasWidth/dpr)+'px';canvas.style.height=Math.round(canvasHeight/dpr)+'px';canvas.style.objectFit='';canvas.style.position='';canvas.style.left='';canvas.style.top='';}if(gl){gl.viewport(0,0,canvasWidth,canvasHeight);resizeGlowResources();}}}

function init(){Object.assign(settings,presets.matrix);if(window.innerWidth<=900&&settings.mode>=4)settings.camDist=1000;if(!initWebGL())return;loadSampleImage();updateCanvasSize();buildBrightnessSampler();setupControls();setupMouseControls();setupMobileUI();syncUI();updateMobilePresetButtons();setTimeout(()=>startWebcam('user'),500);mainLoop();}
window.addEventListener('load',init);
window.addEventListener('resize',updateCanvasSize);
window.addEventListener('orientationchange',()=>setTimeout(updateCanvasSize,100));
})();
</script>
</body>
</html>
